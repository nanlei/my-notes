


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Tech Notes">
      
      
      
        <meta name="author" content="Nan Lei">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.7">
    
    
      
        <title>Spring IoC - Tech Notes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.b8ac9624.min.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/palette.28f3ef9a.min.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=:300,400,400i,700%7C&display=fallback">
        <style>body,input{font-family:"",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#1-ioc" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-announce">
          <div class="md-announce__inner md-grid md-typeset">
            
  <a href="mailto:nanlei1987@gmail.com">
    Mail to <strong>nanlei1987@gmail.com</strong> for your queries.
  </a>

          </div>
        </aside>
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="Tech Notes" class="md-header-nav__button md-logo" aria-label="Tech Notes">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Tech Notes
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Spring IoC
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/nanlei/my-notes/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
          

  

<nav class="md-tabs md-tabs--active" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../.." class="md-tabs__link">
        Home
      </a>
    
  </li>

      
        
  
  
    
    
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="./" class="md-tabs__link md-tabs__link--active">
          Framework
        </a>
      
    </li>
  

  

  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../DataBase/MySQL/master-slave/" class="md-tabs__link">
          DataBase
        </a>
      
    </li>
  

  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../DevOps/devops-centos/" class="md-tabs__link">
          DevOps
        </a>
      
    </li>
  

  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../about/" class="md-tabs__link">
          About
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Tech Notes" class="md-nav__button md-logo" aria-label="Tech Notes">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Tech Notes
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/nanlei/my-notes/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Framework
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Framework" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Framework
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-1" type="checkbox" id="nav-2-1" checked>
    
    <label class="md-nav__link" for="nav-2-1">
      Spring Framework
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Spring Framework" data-md-level="2">
      <label class="md-nav__title" for="nav-2-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Spring Framework
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-1-1" type="checkbox" id="nav-2-1-1" checked>
    
    <label class="md-nav__link" for="nav-2-1-1">
      IoC
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="IoC" data-md-level="3">
      <label class="md-nav__title" for="nav-2-1-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        IoC
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Spring IoC
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Spring IoC" class="md-nav__link md-nav__link--active">
      Spring IoC
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-ioc" class="md-nav__link">
    1. 什么是IoC
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-ioc" class="md-nav__link">
    2. IoC的基本概念
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-ioc" class="md-nav__link">
    3. IoC的实现
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4. 依赖查找和依赖注入
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-spring-ioc" class="md-nav__link">
    5. Spring IoC容器
  </a>
  
    <nav class="md-nav" aria-label="5. Spring IoC容器">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-spring-ioc" class="md-nav__link">
    5.1 Spring IoC 依赖查找
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-spring-ioc" class="md-nav__link">
    5.2 Spring IoC依赖注入
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53-spring-ioc" class="md-nav__link">
    5.3 Spring IoC配置元信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#54-beanfactoryapplictioncontext" class="md-nav__link">
    5.4 BeanFactory和ApplictionContext
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#55-beanfactoryapplicationcontext" class="md-nav__link">
    5.5 BeanFactory和ApplicationContext比较
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#56-spring-ioc" class="md-nav__link">
    5.6 Spring IoC容器的生命周期
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../02-spring-beans/" title="Spring Beans" class="md-nav__link">
      Spring Beans
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-1-2" type="checkbox" id="nav-2-1-2">
    
    <label class="md-nav__link" for="nav-2-1-2">
      Annotation Driven
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Annotation Driven" data-md-level="3">
      <label class="md-nav__title" for="nav-2-1-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Annotation Driven
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../spring-annotation-stereotype-annotation/" title="Stereotype Annotation" class="md-nav__link">
      Stereotype Annotation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../spring-annotation-composed-annotation/" title="Composed Annotation" class="md-nav__link">
      Composed Annotation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../spring-annotation-attributes/" title="Annotation Attributes" class="md-nav__link">
      Annotation Attributes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-2" type="checkbox" id="nav-2-2">
    
    <label class="md-nav__link" for="nav-2-2">
      Spring Boot
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Spring Boot" data-md-level="2">
      <label class="md-nav__title" for="nav-2-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Spring Boot
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-2-1" type="checkbox" id="nav-2-2-1">
    
    <label class="md-nav__link" for="nav-2-2-1">
      Notes
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Notes" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Notes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../SpringBoot/01-spring-boot-application/" title="Standalone Application" class="md-nav__link">
      Standalone Application
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../SpringBoot/02-spring-boot-maven-dependency/" title="Maven Dependencies" class="md-nav__link">
      Maven Dependencies
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../SpringBoot/03-spring-boot-embedded-web-server/" title="Embedded Web Server" class="md-nav__link">
      Embedded Web Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../SpringBoot/04-spring-boot-understanding-auto-config/" title="Understanding Auto-Configuration" class="md-nav__link">
      Understanding Auto-Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../SpringBoot/05-spring-boot-understanding-prod-ready/" title="Understanding Production-Ready" class="md-nav__link">
      Understanding Production-Ready
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-2-2" type="checkbox" id="nav-2-2-2">
    
    <label class="md-nav__link" for="nav-2-2-2">
      Samples
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Samples" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Samples
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../SpringBoot/app-shardingsphere-master-slave-mysql/" title="Shardingsphere master-slave with MySQL" class="md-nav__link">
      Shardingsphere master-slave with MySQL
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      DataBase
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="DataBase" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        DataBase
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1" type="checkbox" id="nav-3-1">
    
    <label class="md-nav__link" for="nav-3-1">
      MySQL
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="MySQL" data-md-level="2">
      <label class="md-nav__title" for="nav-3-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        MySQL
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../DataBase/MySQL/master-slave/" title="Master Slave" class="md-nav__link">
      Master Slave
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2">
    
    <label class="md-nav__link" for="nav-3-2">
      MongoDB
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="MongoDB" data-md-level="2">
      <label class="md-nav__title" for="nav-3-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        MongoDB
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../DataBase/MongoDB/replica-set/" title="Replica Set" class="md-nav__link">
      Replica Set
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      DevOps
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="DevOps" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        DevOps
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-1" type="checkbox" id="nav-4-1">
    
    <label class="md-nav__link" for="nav-4-1">
      Linux
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Linux" data-md-level="2">
      <label class="md-nav__title" for="nav-4-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Linux
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../DevOps/devops-centos/" title="CentOS" class="md-nav__link">
      CentOS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../DevOps/devops-ubuntu/" title="Ubuntu" class="md-nav__link">
      Ubuntu
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-2" type="checkbox" id="nav-4-2">
    
    <label class="md-nav__link" for="nav-4-2">
      Docker
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Docker" data-md-level="2">
      <label class="md-nav__title" for="nav-4-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Docker
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../DevOps/docker/" title="Basic" class="md-nav__link">
      Basic
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      About
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="About" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        About
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../about/" title="Who Am I" class="md-nav__link">
      Who Am I
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-ioc" class="md-nav__link">
    1. 什么是IoC
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-ioc" class="md-nav__link">
    2. IoC的基本概念
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-ioc" class="md-nav__link">
    3. IoC的实现
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4. 依赖查找和依赖注入
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-spring-ioc" class="md-nav__link">
    5. Spring IoC容器
  </a>
  
    <nav class="md-nav" aria-label="5. Spring IoC容器">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-spring-ioc" class="md-nav__link">
    5.1 Spring IoC 依赖查找
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-spring-ioc" class="md-nav__link">
    5.2 Spring IoC依赖注入
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53-spring-ioc" class="md-nav__link">
    5.3 Spring IoC配置元信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#54-beanfactoryapplictioncontext" class="md-nav__link">
    5.4 BeanFactory和ApplictionContext
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#55-beanfactoryapplicationcontext" class="md-nav__link">
    5.5 BeanFactory和ApplicationContext比较
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#56-spring-ioc" class="md-nav__link">
    5.6 Spring IoC容器的生命周期
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/nanlei/my-notes/edit/master/docs/SpringFramework/01-spring-ioc.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                  <h1>Spring IoC</h1>
                
                <h3 align="center"><b>Spring IoC 基础</b></h3>

<h2 id="1-ioc">1. 什么是IoC<a class="headerlink" href="#1-ioc" title="Permanent link">&para;</a></h2>
<p><strong>IoC</strong>(Inversion of Control，控制反转)并不是Spring Framework特有的概念，站在从软件开发角度来理解，<a href="https://en.wikipedia.org/wiki/Inversion_of_control">可以参考</a>。</p>
<p>而广义上的IoC，可以从一句话理解：<code>Don’t call me, we will call you</code>(好莱坞原则)</p>
<h2 id="2-ioc">2. IoC的基本概念<a class="headerlink" href="#2-ioc" title="Permanent link">&para;</a></h2>
<p>广义上的IoC实现，<a href="https://en.wikipedia.org/wiki/Inversion_of_control#Implementation_techniques">可以参考</a>。</p>
<p>在Spring Framework中，在其作者Rod Johnson和Juergen Hoeller做著的<code>《Expert One-on-One™J2EE™Development without EJB》</code>一书中提到：</p>
<p>(<strong>Chapter 6: Lightweight Containers andInversion of Control</strong>)</p>
<blockquote>
<p><strong><em>IoC Implementation Strategies</em></strong></p>
<p>IoC is a broad concept that can be implemented in different ways. There are two main types:</p>
<ul>
<li><strong>Dependency Lookup</strong>:The container provides callbacks to components, and a lookup context. This is the EJB and Apache Avalon approach. It leaves the onus on each component to use container APIs to look up resources and collaborators. The Inversion of Control is limited to the container invoking callback methods that application code can use to obtain resources.</li>
<li><strong>Dependency Injection</strong>:Components do no look up; they provide plain Java methods enabling the container to resolve dependencies. The container is wholly responsible for wiring up components, passing resolved objects in to JavaBean properties or constructors. Use of JavaBean properties is called Setter Injection; use of constructor arguments is called Constructor Injection.</li>
</ul>
</blockquote>
<p>也就是IoC实现策略有依赖查找和依赖注入两种类型，在Spring Framework中都有它们的存在。</p>
<p><strong>IoC的目标</strong></p>
<p><a href="https://en.wikipedia.org/wiki/Inversion_of_control#Overview">可以参考</a></p>
<blockquote>
<p>Inversion of control serves the following design purposes:</p>
<ul>
<li>To decouple the execution of a task from implementation.</li>
<li>To focus a module on the task it is designed for.</li>
<li>To free modules from assumptions about how other systems do what they do and instead rely on contracts.</li>
<li>To prevent side effects when replacing a module.</li>
</ul>
</blockquote>
<p><strong>IoC的职责</strong></p>
<ul>
<li>依赖处理：依赖查找，依赖注入</li>
<li>生命周期管理： 容器，托管的资源(Java Bean或其他资源)</li>
<li>配置：容器，外部化配置，托管的资源(Java Bean或其他资源)</li>
</ul>
<h2 id="3-ioc">3. IoC的实现<a class="headerlink" href="#3-ioc" title="Permanent link">&para;</a></h2>
<ul>
<li>Java SE<ul>
<li>Java Beans</li>
<li>Java ServiceLoader SPI</li>
<li>JNDI(Java Naming and Directory Interface)</li>
</ul>
</li>
<li>Java EE<ul>
<li>EJB(Enterprise Java Bean)</li>
<li>Servlet</li>
</ul>
</li>
<li>Open Source<ul>
<li>Apache Avalon(<a href="https://avalon.apache.org/closed.html">https://avalon.apache.org/closed.html</a>)</li>
<li>PicoContainer(<a href="http://picocontainer.com">http://picocontainer.com</a>)</li>
<li>Google Guice(<a href="https://github.com/google/guice">https://github.com/google/guice</a>)</li>
<li>Spring Framework(<a href="https://spring.io/projects/spring-framework">https://spring.io/projects/spring-framework</a>)</li>
</ul>
</li>
</ul>
<p><strong>Java Beans 作为IoC容器</strong></p>
<ul>
<li>特性：依赖查找，生命周期管理，配置元信息，事件，自定义，资源管理，持久化</li>
<li>规范：</li>
<li>Java Beans(<a href="https://www.oracle.com/java/technologies/javase/javabeans-spec.html">https://www.oracle.com/java/technologies/javase/javabeans-spec.html</a>)</li>
<li>BeanContext(<a href="https://docs.oracle.com/javase/8/docs/technotes/guides/beans/spec/beancontext.html">https://docs.oracle.com/javase/8/docs/technotes/guides/beans/spec/beancontext.html</a>)</li>
</ul>
<p>首先构建一个简单的Java Bean：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">bean</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * POJO class of Person</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * Getter/Setter方法(可读/可写方法)</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="p">{</span>
    <span class="c1">//String to String</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="p">;</span>
    <span class="c1">//String to Integer</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">age</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getAge</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">age</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAge</span><span class="p">(</span><span class="n">Integer</span> <span class="n">age</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">age</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;Person {&quot;</span> <span class="o">+</span>
                <span class="s">&quot;name=&#39;&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">+</span>
                <span class="s">&quot;, age=&quot;</span> <span class="o">+</span> <span class="n">age</span> <span class="o">+</span>
                <span class="sc">&#39;}&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>简单的Java对象(POJO)包含属性和可读/可写方法(Getter/Setter方法)，上例中设置属性<code>name</code>和<code>age</code>，类型为<code>String</code>和<code>Integer</code>来描述<code>Person</code>。</p>
<p>通过<code>BeanInfo</code>来获取Java Bean的信息：
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">bean.Person</span><span class="p">;</span>


<span class="kn">import</span> <span class="nn">java.beans.BeanInfo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.beans.Introspector</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.stream.Stream</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * {@link java.beans.BeanInfo} 示例</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeanInfoDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="c1">//通过自省方式来获取BeanInfo</span>
        <span class="n">BeanInfo</span> <span class="n">beanInfo</span> <span class="o">=</span> <span class="n">Introspector</span><span class="p">.</span><span class="na">getBeanInfo</span><span class="p">(</span><span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="c1">//获取PropertyDescriptor并分析</span>
        <span class="n">Stream</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">beanInfo</span><span class="p">.</span><span class="na">getPropertyDescriptors</span><span class="p">()).</span><span class="na">forEach</span><span class="p">(</span><span class="n">propertyDescriptor</span> <span class="o">-&gt;</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">propertyDescriptor</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>运行程序，得到结果：
<div class="highlight"><pre><span></span><code>java.beans.PropertyDescriptor[name=age; propertyType=class java.lang.Integer; readMethod=public java.lang.Integer bean.Person.getAge(); writeMethod=public void bean.Person.setAge(java.lang.Integer)]
java.beans.PropertyDescriptor[name=class; propertyType=class java.lang.Class; readMethod=public final native java.lang.Class java.lang.Object.getClass()]
java.beans.PropertyDescriptor[name=name; propertyType=class java.lang.String; readMethod=public java.lang.String bean.Person.getName(); writeMethod=public void bean.Person.setName(java.lang.String)]
</code></pre></div></p>
<p>除了我们定义的<code>name</code>和<code>age</code>属性，还有一个<code>class</code>属性，这是因为在<code>java.lang.Object</code>中，有<code>public final native Class&lt;?&gt; getClass();</code>方法定义。而对象访问是通过方法进行的，而不是直接通过字段访问，那么<code>getClass()</code>方法就被认为是<code>class</code>属性的读方法。如果在<code>Person</code>类中不添加Getter和Setter方法，那么BeanInfo是获取不到<code>name</code>和<code>age</code>属性的。</p>
<p>为了排除<code>Object</code>类的影响，修改代码：
<div class="highlight"><pre><span></span><code><span class="n">BeanInfo</span> <span class="n">beanInfo</span> <span class="o">=</span> <span class="n">Introspector</span><span class="p">.</span><span class="na">getBeanInfo</span><span class="p">(</span><span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</code></pre></div></p>
<p><code>getBeanInfo</code>的重载方法<code>public static BeanInfo getBeanInfo(Class&lt;?&gt; beanClass, Class&lt;?&gt; stopClass) throws IntrospectionException</code>可以设置一个<code>stopClass</code>，表示不分析的父类起始点。再次运行程序，就没有<code>java.lang.Class</code>类型的<code>PropertyDescriptor</code>了。</p>
<p>在实际应用中，若要创建一个<code>Person</code>对象，其信息接受用户在UI上输入，那么传输的信息以字符串形式表示，但对于<code>age</code>属性，Java操作的是<code>Integer</code>类型对象，这就有类型转换的问题，要把<code>String</code>转为<code>Integer</code>类型，这里可以给<code>PropertyDescriptor</code>添加<code>PropertyEditor</code>来实现：
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">bean.Person</span><span class="p">;</span>


<span class="kn">import</span> <span class="nn">java.beans.BeanInfo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.beans.Introspector</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.beans.PropertyEditorSupport</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.stream.Stream</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * {@link java.beans.BeanInfo} 示例</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeanInfoDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="c1">//通过自省方式来获取BeanInfo</span>
        <span class="n">BeanInfo</span> <span class="n">beanInfo</span> <span class="o">=</span> <span class="n">Introspector</span><span class="p">.</span><span class="na">getBeanInfo</span><span class="p">(</span><span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="c1">//获取PropertyDescriptor并分析</span>
        <span class="n">Stream</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">beanInfo</span><span class="p">.</span><span class="na">getPropertyDescriptors</span><span class="p">()).</span><span class="na">forEach</span><span class="p">(</span><span class="n">propertyDescriptor</span> <span class="o">-&gt;</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">propertyDescriptor</span><span class="p">);</span>
            <span class="c1">//获取属性名称</span>
            <span class="n">String</span> <span class="n">propertyName</span> <span class="o">=</span> <span class="n">propertyDescriptor</span><span class="p">.</span><span class="na">getName</span><span class="p">();</span>
            <span class="c1">//PropertyDescriptor添加PropertyEditor(PropertyEditor的基础实现是PropertyEditorSupport)</span>
            <span class="n">propertyDescriptor</span><span class="p">.</span><span class="na">setPropertyEditorClass</span><span class="p">(</span><span class="n">PropertyEditorSupport</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
            <span class="c1">//需要特殊处理的情况再使用自定义PropertyEditor覆盖</span>
            <span class="k">if</span> <span class="p">(</span><span class="s">&quot;age&quot;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">propertyName</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">propertyDescriptor</span><span class="p">.</span><span class="na">setPropertyEditorClass</span><span class="p">(</span><span class="n">StringToIntegerPropertyEditor</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">//createObject();</span>
    <span class="p">}</span>

        <span class="cm">/**</span>
<span class="cm">     * String to Integer PropertyEditor</span>
<span class="cm">     */</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">StringToIntegerPropertyEditor</span> <span class="kd">extends</span> <span class="n">PropertyEditorSupport</span> <span class="p">{</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAsText</span><span class="p">(</span><span class="n">String</span> <span class="n">text</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">IllegalArgumentException</span> <span class="p">{</span>
            <span class="c1">//String to Integer</span>
            <span class="n">Integer</span> <span class="n">value</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
            <span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></p>
<p>这里覆盖了<code>PropertyEditorSupport</code>类的<code>public void setAsText(String text) throws java.lang.IllegalArgumentException</code>方法，其原始定义为：
<div class="highlight"><pre><span></span><code>    <span class="cm">/**</span>
<span class="cm">     * Sets the property value by parsing a given String.  May raise</span>
<span class="cm">     * java.lang.IllegalArgumentException if either the String is</span>
<span class="cm">     * badly formatted or if this kind of property can&#39;t be expressed</span>
<span class="cm">     * as text.</span>
<span class="cm">     *</span>
<span class="cm">     * @param text  The string to be parsed.</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAsText</span><span class="p">(</span><span class="n">String</span> <span class="n">text</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">IllegalArgumentException</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="k">instanceof</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">setValue</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">IllegalArgumentException</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></p>
<p>经过覆盖重写，可以支持类型转换。下面实现<code>createObject()</code>方法：
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">bean.Person</span><span class="p">;</span>


<span class="kn">import</span> <span class="nn">java.beans.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Properties</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.stream.Stream</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * {@link java.beans.BeanInfo} 示例</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeanInfoDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="c1">//通过自省方式来获取BeanInfo</span>
        <span class="n">BeanInfo</span> <span class="n">beanInfo</span> <span class="o">=</span> <span class="n">Introspector</span><span class="p">.</span><span class="na">getBeanInfo</span><span class="p">(</span><span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="c1">//获取PropertyDescriptor并分析</span>
        <span class="n">Stream</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">beanInfo</span><span class="p">.</span><span class="na">getPropertyDescriptors</span><span class="p">()).</span><span class="na">forEach</span><span class="p">(</span><span class="n">propertyDescriptor</span> <span class="o">-&gt;</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">propertyDescriptor</span><span class="p">);</span>
            <span class="c1">//获取属性名称</span>
            <span class="n">String</span> <span class="n">propertyName</span> <span class="o">=</span> <span class="n">propertyDescriptor</span><span class="p">.</span><span class="na">getName</span><span class="p">();</span>
            <span class="c1">//PropertyDescriptor添加PropertyEditor(PropertyEditor的基础实现是PropertyEditorSupport)</span>
            <span class="n">propertyDescriptor</span><span class="p">.</span><span class="na">setPropertyEditorClass</span><span class="p">(</span><span class="n">PropertyEditorSupport</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
            <span class="c1">//需要特殊处理的情况再使用自定义PropertyEditor覆盖</span>
            <span class="k">if</span> <span class="p">(</span><span class="s">&quot;age&quot;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">propertyName</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">propertyDescriptor</span><span class="p">.</span><span class="na">setPropertyEditorClass</span><span class="p">(</span><span class="n">StringToIntegerPropertyEditor</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>

        <span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="p">(</span><span class="n">Person</span><span class="p">)</span> <span class="n">createObject</span><span class="p">(</span><span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">beanInfo</span><span class="p">,</span> <span class="s">&quot;person.properties&quot;</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">person</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">createObject</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="p">,</span> <span class="n">BeanInfo</span> <span class="n">beanInfo</span><span class="p">,</span> <span class="n">String</span> <span class="n">source</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="c1">//从source加载资源(以Properties文件为例)</span>
        <span class="n">Properties</span> <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="p">();</span>
        <span class="n">InputStream</span> <span class="n">is</span> <span class="o">=</span> <span class="n">BeanInfoDemo</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">().</span><span class="na">getResourceAsStream</span><span class="p">(</span><span class="n">source</span><span class="p">);</span>
        <span class="n">p</span><span class="p">.</span><span class="na">load</span><span class="p">(</span><span class="n">is</span><span class="p">);</span>

        <span class="n">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">clazz</span><span class="p">.</span><span class="na">newInstance</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">PropertyDescriptor</span> <span class="n">propertyDescriptor</span> <span class="p">:</span> <span class="n">beanInfo</span><span class="p">.</span><span class="na">getPropertyDescriptors</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">//获取属性的写方法</span>
            <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">propertyDescriptor</span><span class="p">.</span><span class="na">getName</span><span class="p">();</span>
            <span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
            <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">propertyDescriptor</span><span class="p">.</span><span class="na">getWriteMethod</span><span class="p">();</span>
            <span class="c1">//获取属性的PropertyEditor</span>
            <span class="n">PropertyEditor</span> <span class="n">pe</span> <span class="o">=</span> <span class="p">(</span><span class="n">PropertyEditor</span><span class="p">)</span> <span class="n">propertyDescriptor</span><span class="p">.</span><span class="na">getPropertyEditorClass</span><span class="p">().</span><span class="na">newInstance</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pe</span><span class="p">.</span><span class="na">getClass</span><span class="p">()</span> <span class="o">==</span> <span class="n">StringToIntegerPropertyEditor</span><span class="p">.</span><span class="na">class</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pe</span><span class="p">.</span><span class="na">setAsText</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">pe</span><span class="p">.</span><span class="na">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">method</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="n">pe</span><span class="p">.</span><span class="na">getValue</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">object</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * String to Integer PropertyEditor</span>
<span class="cm">     */</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">StringToIntegerPropertyEditor</span> <span class="kd">extends</span> <span class="n">PropertyEditorSupport</span> <span class="p">{</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAsText</span><span class="p">(</span><span class="n">String</span> <span class="n">text</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">IllegalArgumentException</span> <span class="p">{</span>
            <span class="c1">//String to Integer</span>
            <span class="n">Integer</span> <span class="n">value</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
            <span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p><code>person.properties</code>文件内容为：
<div class="highlight"><pre><span></span><code><span class="na">name</span><span class="o">=</span><span class="s">Tom</span>
<span class="na">age</span><span class="o">=</span><span class="s">18</span>
</code></pre></div></p>
<p>最终运行结果为：
<div class="highlight"><pre><span></span><code>java.beans.PropertyDescriptor[name=age; propertyType=class java.lang.Integer; writeMethod=public void bean.Person.setAge(java.lang.Integer)]
java.beans.PropertyDescriptor[name=name; propertyType=class java.lang.String; writeMethod=public void bean.Person.setName(java.lang.String)]
Person {name=&#39;Tom&#39;, age=18}
</code></pre></div></p>
<p>这里结合Java反射来创建对象，通过<code>BeanInfo</code>获取对应的<code>PropertyDescriptor</code>信息，再根据<code>PropertyEditor</code>来设置属性值。实现了外部数据到内部对象的数据绑定。</p>
<p>可以看出，Java Beans也可以作为IoC容器。</p>
<p><strong>轻量级IoC容器</strong></p>
<p><strong>特征</strong></p>
<p><code>《Expert One-on-One™J2EE™Development without EJB》</code>一书中提到轻量级IoC容器所具有的特征：</p>
<p>(<strong>Chapter 6: Lightweight Containers andInversion of Control</strong>)</p>
<blockquote>
<p>A container that can manage application code</p>
<p>A container that is quick to start up</p>
<p>A container that doesn’t require any special deployment steps to deploy objects within it.</p>
<p>A container that has such a light footprint and minimal API dependencies that it can be run in a variety of environments</p>
<p>A container that sets the bar for adding a managed object so low in terms of deployment effort and performance overhead that it’s possible to deploy and manage fine-grained objects, as well as coarse-grained components.</p>
</blockquote>
<p><strong>优势</strong></p>
<p><code>《Expert One-on-One™J2EE™Development without EJB》</code>一书中提到轻量级IoC容器所具有的优势：</p>
<p>(<strong>Chapter 6: Lightweight Containers andInversion of Control</strong>)</p>
<blockquote>
<p><strong>Escaping the monolithic container</strong></p>
<p><strong>Maximizing code reusability</strong></p>
<p><strong>Greater object orientation</strong></p>
<p><strong>Greater productivity</strong></p>
</blockquote>
<h2 id="4">4. 依赖查找和依赖注入<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<p>依赖查找是主动通过容器API进行的获取依赖。</p>
<p>依赖注入并不依赖容器API，是被动提供依赖，代码侵入性低。</p>
<p>Spring对依赖注入支持构造器注入和Setter注入，二者的比较<a href="https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/core.html#beans-setter-injection">可以参考</a>。Spring官方现在更推荐的是构造器注入。</p>
<p>而在<code>《Expert One-on-One™J2EE™Development without EJB》</code>一书中，作者更佳详细的比较了两种注入方式，但更倾向于Setter注入。</p>
<p>(Chapter 6: Lightweight Containers andInversion of Control)</p>
<blockquote>
<p><strong><em>Choosing between Setter and Constructor Injection</em></strong></p>
<p>Advantages of Setter Injection include:</p>
<ul>
<li>JavaBean properties are well supported in IDEs.</li>
<li>JavaBean properties are self-documenting.</li>
<li>JavaBean properties are inherited by subclasses without the need for any code.</li>
<li>It’s possible to use the standard JavaBeans property-editor machinery for type conversions if necessary.</li>
<li>Many existing JavaBeans can be used within a JavaBean-oriented IoC container without modification.</li>
<li>If there is a corresponding getter for each setter (making the property readable, as well as writable), it is possible to ask the component for its current configuration state. This is particularly useful if we want to persist that state: for example, in an XML form or in a database. With Constructor Injection, there’s no way to find the current state.</li>
<li>Setter Injection works well for objects that have default values, meaning that not all properties need to be supplied at runtime.</li>
</ul>
<p>Disadvantages include:</p>
<ul>
<li>The order in which setters are called is not expressed in any contract. Thus, we sometimes need to invoke a method after the last setter has been called to initialize the component. Spring provides the <code>org.springframework.beans.factory.InitializingBean</code> interface for this; it also provides the ability to invoke an arbitrary init method. However, this contract must be documented to ensure correct use outside a container.</li>
<li>Not all the necessary setters may have been called before use. The object can thus be left partially configured.</li>
</ul>
<p>Advantages of Constructor Injection include:</p>
<ul>
<li>Each managed object is guaranteed to be in a consistent state—fully configured—before it can be invoked in any business methods. This is the primary motivation of Constructor Injection. (However, it is possible to achieve the same result with JavaBeans via dependency checking, as Spring can optionally perform.) There’s no need for initialization methods.</li>
<li>There may be slightly less code than results from the use of multiple JavaBean methods, although will be no difference in complexity.</li>
</ul>
<p>Disadvantages include:</p>
<ul>
<li>Although also a Java-language feature, multi-argument constructors are probably less common in existing code than use of JavaBean properties.</li>
<li>Java constructor arguments don’t have names visible by introspection. (现在可以通过注解来处理)</li>
<li>Constructor argument lists are less well supported by IDEs than JavaBean setter methods.</li>
<li>Long constructor argument lists and large constructor bodies can become unwieldy.</li>
<li>Concrete inheritance can become problematic</li>
<li>Poor support for optional properties, compared to JavaBeans, which can have default values.</li>
<li>Unit testing can be slightly more difficult</li>
<li>When collaborators are passed in on object construction, it becomes impossible to change the reference held in the object. </li>
</ul>
</blockquote>
<p>两种方式并无好坏之分，在各自合适的场景下使用即可。</p>
<h2 id="5-spring-ioc">5. Spring IoC容器<a class="headerlink" href="#5-spring-ioc" title="Permanent link">&para;</a></h2>
<h3 id="51-spring-ioc">5.1 Spring IoC 依赖查找<a class="headerlink" href="#51-spring-ioc" title="Permanent link">&para;</a></h3>
<p>Spring IoC容器中依赖查找可以分为：</p>
<ul>
<li>根据Bean名称查找(实时，延迟)</li>
<li>根据Bean类型查找(单对象，集合对象)</li>
<li>根据Bean名称+类型复合查找</li>
<li>根据Java注解查找(单对象，集合对象)</li>
</ul>
<p>参考示例：</p>
<p>首先引入Spring Ioc核心依赖：
<div class="highlight"><pre><span></span><code>        <span class="c">&lt;!-- Spring IoC 核心依赖 --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-context<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>5.2.8.RELEASE<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></p>
<p>创建Spring XML配置文件<code>dependency-lookup.xml</code>，放在<code>resources</code>目录下：
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans</span>
<span class="s">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>
        ......
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></p>
<p>创建Java实体对象，用于示例操作：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.ioc.overview.domain</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">age</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getAge</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">age</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAge</span><span class="p">(</span><span class="n">Integer</span> <span class="n">age</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">age</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;Person{&quot;</span> <span class="o">+</span>
                <span class="s">&quot;name=&#39;&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">+</span>
                <span class="s">&quot;, age=&quot;</span> <span class="o">+</span> <span class="n">age</span> <span class="o">+</span>
                <span class="sc">&#39;}&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>在Spring XML配置文件中创建一个<code>bean</code>：
<div class="highlight"><pre><span></span><code>    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;person&quot;</span> <span class="na">class=</span><span class="s">&quot;deep.in.spring.ioc.overview.domain.Person&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">value=</span><span class="s">&quot;Tom&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;age&quot;</span> <span class="na">value=</span><span class="s">&quot;18&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
</code></pre></div></p>
<p>创建引导类：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.ioc.overview.dependency.lookup</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.ioc.overview.domain.Person</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.BeanFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.ClassPathXmlApplicationContext</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 依赖查找示例</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DependencyLookupDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//配置XML配置文件</span>
        <span class="c1">//启动Spring应用上下文</span>
        <span class="n">BeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathXmlApplicationContext</span><span class="p">(</span><span class="s">&quot;classpath:/dependency-lookup.xml&quot;</span><span class="p">);</span>
        <span class="c1">//按名称实时查找</span>
        <span class="n">lookupInRealTime</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">,</span> <span class="s">&quot;person&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">lookupInRealTime</span><span class="p">(</span><span class="n">BeanFactory</span> <span class="n">beanFactory</span><span class="p">,</span> <span class="n">String</span> <span class="n">beanName</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Lookup in Realtime: &quot;</span> <span class="o">+</span> <span class="n">object</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>运行程序，结果如下：
<div class="highlight"><pre><span></span><code>Lookup in Realtime: Person{name=&#39;Tom&#39;, age=18}
</code></pre></div></p>
<p>添加延迟查找<code>bean</code>，使用<code>ObjectFactoryCreatingFactoryBean</code>类型：
<div class="highlight"><pre><span></span><code>    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;objectFactory&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.beans.factory.config.ObjectFactoryCreatingFactoryBean&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;targetBeanName&quot;</span> <span class="na">value=</span><span class="s">&quot;person&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
</code></pre></div></p>
<p><code>ObjectFactoryCreatingFactoryBean</code>类型有个String类型的属性<code>targetBeanName</code>，就是目标<code>bean</code>的名称，这里设置为<code>person</code>。</p>
<p>创建对应的Java方法：
<div class="highlight"><pre><span></span><code>    <span class="c1">//lookupInLazy(beanFactory, &quot;objectFactory&quot;); 调用方法</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">lookupInLazy</span><span class="p">(</span><span class="n">BeanFactory</span> <span class="n">beanFactory</span><span class="p">,</span> <span class="n">String</span> <span class="n">beanName</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ObjectFactory</span> <span class="n">objectFactory</span> <span class="o">=</span> <span class="p">(</span><span class="n">ObjectFactory</span><span class="p">)</span> <span class="n">beanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
        <span class="n">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">objectFactory</span><span class="p">.</span><span class="na">getObject</span><span class="p">();</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Lookup in Lazy: &quot;</span> <span class="o">+</span> <span class="n">object</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></p>
<p>再次运行引导程序，结果为：
<div class="highlight"><pre><span></span><code>Lookup in Realtime: Person{name=&#39;Tom&#39;, age=18}
Lookup in Lazy: Person{name=&#39;Tom&#39;, age=18}
</code></pre></div></p>
<p>按照Bean类型查找时，修改获取<code>bean</code>的方法即可：
<div class="highlight"><pre><span></span><code>    <span class="c1">//lookupByType(beanFactory, Person.class); 调用方法</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">lookupByType</span><span class="p">(</span><span class="n">BeanFactory</span> <span class="n">beanFactory</span><span class="p">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">clazz</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Lookup By Type: &quot;</span> <span class="o">+</span> <span class="n">object</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></p>
<p>按照Bean类型查找集合对象，需要用到<code>BeanFactory</code>的子类<code>ListableBeanFactory</code>中的相关方法：
<div class="highlight"><pre><span></span><code>    <span class="c1">//lookupByCollectionType(beanFactory, Person.class); 调用方法</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">lookupByCollectionType</span><span class="p">(</span><span class="n">BeanFactory</span> <span class="n">beanFactory</span><span class="p">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">beanFactory</span> <span class="k">instanceof</span> <span class="n">ListableBeanFactory</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ListableBeanFactory</span> <span class="n">listableBeanFactory</span> <span class="o">=</span> <span class="p">(</span><span class="n">ListableBeanFactory</span><span class="p">)</span> <span class="n">beanFactory</span><span class="p">;</span>
            <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="o">?&gt;</span> <span class="n">collection</span> <span class="o">=</span> <span class="n">listableBeanFactory</span><span class="p">.</span><span class="na">getBeansOfType</span><span class="p">(</span><span class="n">clazz</span><span class="p">);</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Lookup By collection: &quot;</span> <span class="o">+</span> <span class="n">collection</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></p>
<p>同时在XML配置文件中多创建一个<code>Person</code>类型的<code>bean</code>：
<div class="highlight"><pre><span></span><code>    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;person&quot;</span> <span class="na">class=</span><span class="s">&quot;deep.in.spring.ioc.overview.domain.Person&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">value=</span><span class="s">&quot;Tom&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;age&quot;</span> <span class="na">value=</span><span class="s">&quot;18&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;person2&quot;</span> <span class="na">class=</span><span class="s">&quot;deep.in.spring.ioc.overview.domain.Person&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">value=</span><span class="s">&quot;Jerry&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;age&quot;</span> <span class="na">value=</span><span class="s">&quot;18&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
</code></pre></div></p>
<p>直接运行程序，可以得到：
<div class="highlight"><pre><span></span><code>Lookup By collection: {person=Person{name=&#39;Tom&#39;, age=18}, person2=Person{name=&#39;Jerry&#39;, age=18}}
</code></pre></div></p>
<p>按类型和名称同时查找时，使用<code>BeanFactory</code>的<code>&lt;T&gt; T getBean(String name, Class&lt;T&gt; requiredType) throws BeansException;</code>方法即可。</p>
<p>按注解查找，需要先创建注解：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.ioc.overview.annotation</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.ElementType</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.RetentionPolicy</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="p">;</span>

<span class="nd">@Target</span><span class="p">(</span><span class="n">ElementType</span><span class="p">.</span><span class="na">TYPE</span><span class="p">)</span>
<span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">Admin</span> <span class="p">{</span>
<span class="p">}</span>
</code></pre></div></p>
<p>该注解仅有标记性作用，同时创建实体类<code>Administrator</code>：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.ioc.overview.domain</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.ioc.overview.annotation.Admin</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Administrator</span>
<span class="cm"> */</span>
<span class="nd">@Admin</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Administrator</span> <span class="kd">extends</span> <span class="n">Person</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">userName</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getUserName</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">userName</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUserName</span><span class="p">(</span><span class="n">String</span> <span class="n">userName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">userName</span> <span class="o">=</span> <span class="n">userName</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPassword</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">password</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPassword</span><span class="p">(</span><span class="n">String</span> <span class="n">password</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">password</span> <span class="o">=</span> <span class="n">password</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;Administrator{&quot;</span> <span class="o">+</span>
                <span class="s">&quot;userName=&#39;&quot;</span> <span class="o">+</span> <span class="n">userName</span> <span class="o">+</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">+</span>
                <span class="s">&quot;, password=&#39;&quot;</span> <span class="o">+</span> <span class="n">password</span> <span class="o">+</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">+</span>
                <span class="s">&quot;} &quot;</span> <span class="o">+</span> <span class="kd">super</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p><code>Administrator</code>继承自<code>Person</code>，并新增2个属性，在XML配置文件中新增相关的<code>bean</code>：
<div class="highlight"><pre><span></span><code>    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;admin&quot;</span> <span class="na">class=</span><span class="s">&quot;deep.in.spring.ioc.overview.domain.Administrator&quot;</span> <span class="na">parent=</span><span class="s">&quot;person&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;userName&quot;</span> <span class="na">value=</span><span class="s">&quot;tom@abc.com&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span> <span class="na">value=</span><span class="s">&quot;123456&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
</code></pre></div></p>
<p>编写相关查找方法：
<div class="highlight"><pre><span></span><code>    <span class="c1">//lookupByAnnotation(beanFactory, Admin.class); 调用方法</span>
    <span class="p">...</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">lookupByAnnotation</span><span class="p">(</span><span class="n">BeanFactory</span> <span class="n">beanFactory</span><span class="p">,</span> <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Annotation</span><span class="o">&gt;</span> <span class="n">annotationClass</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">beanFactory</span> <span class="k">instanceof</span> <span class="n">ListableBeanFactory</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ListableBeanFactory</span> <span class="n">listableBeanFactory</span> <span class="o">=</span> <span class="p">(</span><span class="n">ListableBeanFactory</span><span class="p">)</span> <span class="n">beanFactory</span><span class="p">;</span>
            <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">beans</span> <span class="o">=</span> <span class="p">(</span><span class="n">Map</span><span class="p">)</span> <span class="n">listableBeanFactory</span><span class="p">.</span><span class="na">getBeansWithAnnotation</span><span class="p">(</span><span class="n">annotationClass</span><span class="p">);</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Lookup collection &quot;</span> <span class="o">+</span> <span class="n">annotationClass</span><span class="p">.</span><span class="na">getSimpleName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="n">beans</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></p>
<p>运行程序，得到结果：
<div class="highlight"><pre><span></span><code>Lookup collection Admin: {admin=Administrator{userName=&#39;tom@abc.com&#39;, password=&#39;123456&#39;} Person{name=&#39;Tom&#39;, age=18}}
</code></pre></div></p>
<h3 id="52-spring-ioc">5.2 Spring IoC依赖注入<a class="headerlink" href="#52-spring-ioc" title="Permanent link">&para;</a></h3>
<p>Spring IoC依赖注入可以分为：</p>
<ul>
<li>根据Bean名称注入</li>
<li>根据Bean类型查找(单对象，集合对象)</li>
<li>容器内建Bean对象注入</li>
<li>非Bean对象注入</li>
<li>注入方式可分为：实时注入，延迟注入</li>
</ul>
<p>参考示例：</p>
<p>首先创建XML配置文件<code>dependency-injection</code>：
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xmlns:util=</span><span class="s">&quot;http://www.springframework.org/schema/util&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;</span>
<span class="s">        http://www.springframework.org/schema/beans https://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://www.springframework.org/schema/util https://www.springframework.org/schema/util/spring-util.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- 复用dependency-lookup.xml --&gt;</span>
    <span class="nt">&lt;import</span> <span class="na">resource=</span><span class="s">&quot;dependency-lookup.xml&quot;</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;personRepository&quot;</span> <span class="na">class=</span><span class="s">&quot;deep.in.spring.ioc.overview.repository.PersonRepository&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- 手动配置 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;persons&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;util:list&gt;</span>
                <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;person2&quot;</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;admin&quot;</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;person&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/util:list&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></p>
<p>将<code>dependency-lookup.xml</code>作为资源引入，同时声明一个<code>Repository</code>类型的bean：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.ioc.overview.repository</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.ioc.overview.domain.Person</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 成员信息仓库</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PersonRepository</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">persons</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="nf">getPersons</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">persons</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPersons</span><span class="p">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">persons</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">persons</span> <span class="o">=</span> <span class="n">persons</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>在XML配置文件中，给<code>persons</code>对象进行依赖注入，就是在<code>dependency-lookup.xml</code>中定义的3个<code>bean</code>，<code>person2</code>，<code>admin</code>和<code>person</code>。</p>
<p>编写引导类：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.ioc.overview.dependency.injection</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.ioc.overview.repository.PersonRepository</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.BeanFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.ClassPathXmlApplicationContext</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 依赖注入示例</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DependencyInjectionDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//配置XML配置文件</span>
        <span class="c1">//启动Spring应用上下文</span>
        <span class="n">BeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathXmlApplicationContext</span><span class="p">(</span><span class="s">&quot;classpath:/dependency-injection.xml&quot;</span><span class="p">);</span>
        <span class="c1">//获取personRepository</span>
        <span class="n">PersonRepository</span> <span class="n">personRepository</span> <span class="o">=</span> <span class="p">(</span><span class="n">PersonRepository</span><span class="p">)</span> <span class="n">beanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;personRepository&quot;</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">personRepository</span><span class="p">.</span><span class="na">getPersons</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>运行程序，得到结果：
<div class="highlight"><pre><span></span><code>[Person{name=&#39;Jerry&#39;, age=18}, Administrator{userName=&#39;tom@abc.com&#39;, password=&#39;123456&#39;} Person{name=&#39;Tom&#39;, age=18}, Person{name=&#39;Tom&#39;, age=18}]
</code></pre></div></p>
<p>可以看到，通过依赖注入，3个<code>bean</code>都正确返回了，但却是在XML配置文件里硬编码指定的(手动配置)，当<code>bean</code>过多时，显然不可取。可以使用自动绑定的方式来代替：
<div class="highlight"><pre><span></span><code>    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;personRepository&quot;</span> <span class="na">class=</span><span class="s">&quot;deep.in.spring.ioc.overview.repository.PersonRepository&quot;</span>
          <span class="na">autowire=</span><span class="s">&quot;byType&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- Auto-Wiring --&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
</code></pre></div></p>
<p>通过类型来自动绑定，再次运行程序，得到结果：
<div class="highlight"><pre><span></span><code>[Person{name=&#39;Tom&#39;, age=18}, Person{name=&#39;Jerry&#39;, age=18}, Administrator{userName=&#39;tom@abc.com&#39;, password=&#39;123456&#39;} Person{name=&#39;Tom&#39;, age=18}]
</code></pre></div></p>
<p><code>bean</code>的输出顺序和配置的顺序一致，而手动配置的顺序也和打印的一致。</p>
<p>非Bean对象的注入，可以修改<code>PersonRepository</code>：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.ioc.overview.repository</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.ioc.overview.domain.Person</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.BeanFactory</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 成员信息仓库</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PersonRepository</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">persons</span><span class="p">;</span> <span class="c1">//自定义Bean</span>

    <span class="kd">private</span> <span class="n">BeanFactory</span> <span class="n">beanFactory</span><span class="p">;</span><span class="c1">//内建非Bean对象</span>

    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="nf">getPersons</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">persons</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPersons</span><span class="p">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">persons</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">persons</span> <span class="o">=</span> <span class="n">persons</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">BeanFactory</span> <span class="nf">getBeanFactory</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">beanFactory</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setBeanFactory</span><span class="p">(</span><span class="n">BeanFactory</span> <span class="n">beanFactory</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">beanFactory</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>修改引导程序：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.ioc.overview.dependency.injection</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.ioc.overview.repository.PersonRepository</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.BeanFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.ClassPathXmlApplicationContext</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 依赖注入示例</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DependencyInjectionDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//配置XML配置文件</span>
        <span class="c1">//启动Spring应用上下文</span>
        <span class="n">BeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathXmlApplicationContext</span><span class="p">(</span><span class="s">&quot;classpath:/dependency-injection.xml&quot;</span><span class="p">);</span>
        <span class="c1">//获取personRepository</span>
        <span class="n">PersonRepository</span> <span class="n">personRepository</span> <span class="o">=</span> <span class="p">(</span><span class="n">PersonRepository</span><span class="p">)</span> <span class="n">beanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;personRepository&quot;</span><span class="p">);</span>
        <span class="c1">//依赖注入(内建依赖)</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">beanFactory</span> <span class="o">==</span> <span class="n">personRepository</span><span class="p">.</span><span class="na">getBeanFactory</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>运行程序，结果为<code>false</code>，说明<code>beanFactory</code>和<code>PersonRepository</code>中的非Bean对象<code>beanFactory</code>是不同的，可以将它们打印出来看：
<div class="highlight"><pre><span></span><code>        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">personRepository</span><span class="p">.</span><span class="na">getBeanFactory</span><span class="p">());</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>
</code></pre></div></p>
<p>结果为：
<div class="highlight"><pre><span></span><code>org.springframework.beans.factory.support.DefaultListableBeanFactory@73f792cf: defining beans [person,person2,admin,objectFactory,personRepository]; root of factory hierarchy
org.springframework.context.support.ClassPathXmlApplicationContext@246b179d, started on Thu Oct 29 23:01:17 CST 2020
</code></pre></div></p>
<p>说明其是内建对象，而不是Bean，如果是Bean，可以通过依赖查找获取到：
<div class="highlight"><pre><span></span><code>        <span class="c1">//依赖查找(错误)</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">BeanFactory</span><span class="p">.</span><span class="na">class</span><span class="p">));</span>
</code></pre></div></p>
<p>但这里是错误的：
<div class="highlight"><pre><span></span><code>Exception in thread &quot;main&quot; org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type &#39;org.springframework.beans.factory.BeanFactory&#39; available
</code></pre></div></p>
<p>示例本身也说明了依赖查找和依赖注入是不同的。</p>
<p>延迟注入，和延迟查找类似，可以借助<code>ObjectFactory</code>，修改<code>PersonRepository</code>：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.ioc.overview.repository</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.ioc.overview.domain.Person</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.BeanFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.ObjectFactory</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 成员信息仓库</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PersonRepository</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">persons</span><span class="p">;</span> <span class="c1">//自定义Bean</span>

    <span class="kd">private</span> <span class="n">BeanFactory</span> <span class="n">beanFactory</span><span class="p">;</span><span class="c1">//内建非Bean对象</span>

    <span class="kd">private</span> <span class="n">ObjectFactory</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">personObjectFactory</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="nf">getPersons</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">persons</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPersons</span><span class="p">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">persons</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">persons</span> <span class="o">=</span> <span class="n">persons</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">BeanFactory</span> <span class="nf">getBeanFactory</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">beanFactory</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setBeanFactory</span><span class="p">(</span><span class="n">BeanFactory</span> <span class="n">beanFactory</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">beanFactory</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">ObjectFactory</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="nf">getPersonObjectFactory</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">personObjectFactory</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPersonObjectFactory</span><span class="p">(</span><span class="n">ObjectFactory</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">personObjectFactory</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">personObjectFactory</span> <span class="o">=</span> <span class="n">personObjectFactory</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>对应修改引导程序：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.ioc.overview.dependency.injection</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.ioc.overview.repository.PersonRepository</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.BeanFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.ObjectFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.ClassPathXmlApplicationContext</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 依赖注入示例</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DependencyInjectionDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//配置XML配置文件</span>
        <span class="c1">//启动Spring应用上下文</span>
        <span class="n">BeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathXmlApplicationContext</span><span class="p">(</span><span class="s">&quot;classpath:/dependency-injection.xml&quot;</span><span class="p">);</span>
        <span class="c1">//获取personRepository</span>
        <span class="n">PersonRepository</span> <span class="n">personRepository</span> <span class="o">=</span> <span class="p">(</span><span class="n">PersonRepository</span><span class="p">)</span> <span class="n">beanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;personRepository&quot;</span><span class="p">);</span>
        <span class="c1">//延迟注入</span>
        <span class="n">ObjectFactory</span> <span class="n">personObjectFactory</span> <span class="o">=</span> <span class="n">personRepository</span><span class="p">.</span><span class="na">getPersonObjectFactory</span><span class="p">();</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">personObjectFactory</span><span class="p">.</span><span class="na">getObject</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>直接运行：
<div class="highlight"><pre><span></span><code>Exception in thread &quot;main&quot; org.springframework.beans.factory.NoUniqueBeanDefinitionException: No qualifying bean of type &#39;deep.in.spring.ioc.overview.domain.Person&#39; available: expected single matching bean but found 3: person,person2,admin
</code></pre></div></p>
<p>这里的问题是定义了3个<code>Person</code>类型的<code>bean</code>，但程序期望只得到一个，可以修改配置文件，添加属性：
<div class="highlight"><pre><span></span><code>    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;admin&quot;</span> <span class="na">class=</span><span class="s">&quot;deep.in.spring.ioc.overview.domain.Administrator&quot;</span> <span class="na">parent=</span><span class="s">&quot;person&quot;</span> <span class="na">primary=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;userName&quot;</span> <span class="na">value=</span><span class="s">&quot;tom@abc.com&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span> <span class="na">value=</span><span class="s">&quot;123456&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
</code></pre></div></p>
<p>在其中的一个<code>bean</code>上添加<code>primary="true"</code>即可，再次运行即可得到结果。</p>
<p>修改<code>ObjectFactory</code>获取的内容为<code>ApplicationContext</code>：
<div class="highlight"><pre><span></span><code>    <span class="kd">private</span> <span class="n">ObjectFactory</span><span class="o">&lt;</span><span class="n">ApplicationContext</span><span class="o">&gt;</span> <span class="n">objectFactory</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="kd">public</span> <span class="n">ObjectFactory</span><span class="o">&lt;</span><span class="n">ApplicationContext</span><span class="o">&gt;</span> <span class="nf">getObjectFactory</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">objectFactory</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setObjectFactory</span><span class="p">(</span><span class="n">ObjectFactory</span><span class="o">&lt;</span><span class="n">ApplicationContext</span><span class="o">&gt;</span> <span class="n">objectFactory</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">objectFactory</span> <span class="o">=</span> <span class="n">objectFactory</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></p>
<p>修改引导程序：
<div class="highlight"><pre><span></span><code>        <span class="n">ObjectFactory</span> <span class="n">objectFactory</span> <span class="o">=</span> <span class="n">personRepository</span><span class="p">.</span><span class="na">getObjectFactory</span><span class="p">();</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">objectFactory</span><span class="p">.</span><span class="na">getObject</span><span class="p">());</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>
</code></pre></div></p>
<p>此时得到的结果就是<code>beanFactory</code>，它们是一个东西。</p>
<p>容器内建Bean对象：
<div class="highlight"><pre><span></span><code>        <span class="c1">//容器内建Bean</span>
        <span class="n">Environment</span> <span class="n">environment</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">environment</span><span class="p">);</span>
</code></pre></div></p>
<p>运行输出：
<div class="highlight"><pre><span></span><code>StandardEnvironment {activeProfiles=[], defaultProfiles=[default], propertySources=[PropertiesPropertySource {name=&#39;systemProperties&#39;}, SystemEnvironmentPropertySource {name=&#39;systemEnvironment&#39;}]}
</code></pre></div></p>
<p>由此总结Spring IoC依赖来源：</p>
<ul>
<li>自定义Bean</li>
<li>容器内建依赖</li>
<li>容器内建Bean对象</li>
</ul>
<h3 id="53-spring-ioc">5.3 Spring IoC配置元信息<a class="headerlink" href="#53-spring-ioc" title="Permanent link">&para;</a></h3>
<ul>
<li>Bean的定义配置：XML文件/Properties文件/Java注解/Java API</li>
<li>IoC容器配置：XML文件/Java注解/Java API</li>
<li>外部化属性配置：Java注解</li>
</ul>
<h3 id="54-beanfactoryapplictioncontext">5.4 <span id="5.4"><code>BeanFactory</code>和<code>ApplictionContext</code></span><a class="headerlink" href="#54-beanfactoryapplictioncontext" title="Permanent link">&para;</a></h3>
<p>Spring官方文档对此有解释，<a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-introduction">可以参考</a>：</p>
<blockquote>
<p>The <code>org.springframework.beans</code> and <code>org.springframework.context</code> packages are the basis for Spring Framework’s IoC container. The <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/beans/factory/BeanFactory.html"><code>BeanFactory</code></a> interface provides an advanced configuration mechanism capable of managing any type of <strong>object</strong>. <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/context/ApplicationContext.html"><code>ApplicationContext</code></a> is a sub-interface of <code>BeanFactory</code>. It adds:</p>
<ul>
<li>Easier integration with Spring’s AOP features</li>
<li>Message resource handling (for use in internationalization)</li>
<li>Event publication</li>
<li>Application-layer specific contexts such as the <code>WebApplicationContext</code> for use in web applications.</li>
</ul>
<p>In short, the <code>BeanFactory</code> provides the configuration framework and basic functionality, and the <code>ApplicationContext</code> adds more enterprise-specific functionality. The <code>ApplicationContext</code> is a complete superset of the <code>BeanFactory</code> and is used exclusively in this chapter in descriptions of Spring’s IoC container. For more information on using the <code>BeanFactory</code> instead of the <code>ApplicationContext</code>, <a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-beanfactory">see The BeanFactory</a>.</p>
</blockquote>
<p>上面的示例中，引导程序的第一行：
<div class="highlight"><pre><span></span><code>BeanFactory beanFactory = new ClassPathXmlApplicationContext(&quot;classpath:/dependency-injection.xml&quot;);
</code></pre></div></p>
<p>就印证了官方文档的内容，<code>ApplicationContext</code>是<code>BeanFactory</code>的超集，也可以改为：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.ioc.overview.dependency.injection</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.ioc.overview.repository.PersonRepository</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.ApplicationContext</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.ClassPathXmlApplicationContext</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 依赖注入示例</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DependencyInjectionDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//配置XML配置文件</span>
        <span class="c1">//启动Spring应用上下文</span>
        <span class="n">ApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathXmlApplicationContext</span><span class="p">(</span><span class="s">&quot;classpath:/dependency-injection.xml&quot;</span><span class="p">);</span>
        <span class="c1">//获取personRepository</span>
        <span class="n">PersonRepository</span> <span class="n">personRepository</span> <span class="o">=</span> <span class="p">(</span><span class="n">PersonRepository</span><span class="p">)</span> <span class="n">applicationContext</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;personRepository&quot;</span><span class="p">);</span>

        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">applicationContext</span> <span class="o">==</span> <span class="n">personRepository</span><span class="p">.</span><span class="na">getBeanFactory</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>下面来看<code>applicationContext == personRepository.getBeanFactory()</code>为<code>false</code>的问题。</p>
<p>因为在配置<code>bean</code>的时候，设置了<code>autowire="byType"</code>，所以<code>BeanFactory</code>依赖被注入到<code>personRepository</code>中，可以通过<code>personRepository.getBeanFactory()</code>获取到，但这里注入的<code>BeanFactory</code>和引导类中的<code>ApplicationContext</code>(<code>BeanFactory</code>)并不是一回事，因为在<code>ApplicationContext</code>的继承链上，既有继承，还有组合。</p>
<p>在<code>ClassPathXmlApplicationContext</code>的继承链上，有抽象类<code>AbstractApplicationContext</code>，其中有抽象方法<code>getBeanFactory()</code>：
<img alt="" src="../img/spring.ioc.applicationcontext.getbeanfactory.png" />
(如图所示继承关系不包含所实现的接口)</p>
<p>而这个方法依然是覆盖了<code>ConfigurableApplicationContext</code>接口中的<code>getBeanFactory()</code>方法。其接口继承关系为：<code>ConfigurableApplicationContext --&gt; ApplicationContext --&gt; ListableBeanFactory --&gt; BeanFactory</code>。</p>
<p>既然有<code>BeanFactory</code>继承关系，子接口还定义方法去获取，说明这里不单单是继承。在<code>AbstractRefreshableApplicationContext</code>中有<code>getBeanFactory()</code>的实现代码：
<div class="highlight"><pre><span></span><code>    <span class="cm">/** Bean factory for this context. */</span>
    <span class="nd">@Nullable</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">DefaultListableBeanFactory</span> <span class="n">beanFactory</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">ConfigurableListableBeanFactory</span> <span class="nf">getBeanFactory</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">DefaultListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">beanFactory</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">beanFactory</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;BeanFactory not initialized or already closed - &quot;</span> <span class="o">+</span>
                    <span class="s">&quot;call &#39;refresh&#39; before accessing beans via the ApplicationContext&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">beanFactory</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></p>
<p>所以上面程序打印<code>personRepository.getBeanFactory()</code>的结果时，返回的就是<code>DefaultListableBeanFactory</code>，就是从这里来的，是组合来的。再看其中的<code>getBean()</code>系列方法：
<img alt="" src="../img/spring.ioc.applicationcontext.getbean.png" /></p>
<p>可以看到<code>getBean()</code>系列方法也是从组合对象中进行获取的。而引导类中的<code>beanFactory</code>才是<code>ClassPathXmlApplicationContext</code>，是继承来的。</p>
<p>综上所述，<code>ApplicationContext</code>就是<code>BeanFactory</code>，它们具有继承关系，但<code>ApplicationContext</code>又组合了一个<code>BeanFactory</code>的实现。</p>
<p>而<code>ApplicationContext</code>和<code>BeanFactory</code>本身的区别，参考官方文档的解释即可。</p>
<p><code>BeanFactory</code>是Spring底层IoC容器，<code>ApplicationContext</code>除了作为IoC容器，还提供：</p>
<ul>
<li>面向切面(AOP)</li>
<li>配置元信息(Configuration Metadata)</li>
<li>资源管理(Resources)</li>
<li>事件(Events)</li>
<li>国际化(i18n)</li>
<li>注解(Annotation)</li>
<li>Environment抽象(配置，外部化配置)</li>
</ul>
<h3 id="55-beanfactoryapplicationcontext">5.5 <code>BeanFactory</code>和<code>ApplicationContext</code>比较<a class="headerlink" href="#55-beanfactoryapplicationcontext" title="Permanent link">&para;</a></h3>
<p>上节示例中，Spring为Bean默认注入的<code>BeanFactory</code>类型是<code>DefaultListableBeanFactory</code>，它实现了<code>ListableBeanFactory</code>接口，<code>ListableBeanFactory</code>接口继承自<code>BeanFactory</code>接口。</p>
<p>由此，也可以直接使用<code>DefaultListableBeanFactory</code>作为IoC容器，比如：
<div class="highlight"><pre><span></span><code><span class="n">DefaultListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultListableBeanFactory</span><span class="p">();</span>
</code></pre></div></p>
<p>但上节示例中，使用的是基于类路径下XML的<code>ApplicationContext</code>实现，将配置文件地址作为构造方法参数传入，而直接使用<code>BeanFactory</code>类型时，需要将Bean信息(配置文件)手动加载。</p>
<p>基于XML方式的Bean的加载API是<code>XmlBeanDefinitionReader</code>，其需要一个<code>BeanDefinitionRegistry</code>类型的参数来进行构造，而<code>DefaultListableBeanFactory</code>恰好实现了<code>BeanDefinitionRegistry</code>接口，可以直接使用：
<div class="highlight"><pre><span></span><code><span class="n">XmlBeanDefinitionReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">XmlBeanDefinitionReader</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>
</code></pre></div></p>
<p>有了<code>XmlBeanDefinitionReader</code>之后，加载配置文件即可，其<code>loadBeanDefinitions(String location)</code>方法即可读取配置文件，方法返回值为<code>int</code>类型，是找到<code>bean</code>定义的数量：
<div class="highlight"><pre><span></span><code><span class="n">String</span> <span class="n">configLocation</span> <span class="o">=</span> <span class="s">&quot;classpath:/dependency-lookup.xml&quot;</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">beanDefinitionsCount</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="na">loadBeanDefinitions</span><span class="p">(</span><span class="n">configLocation</span><span class="p">);</span>
</code></pre></div></p>
<p>调用该方法后，<code>BeanFactory</code>类型的IoC容器就已经初始化好，可以继续使用了，完整示例如下：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.ioc.overview.container</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.ioc.overview.domain.Person</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.BeanFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.ListableBeanFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.support.DefaultListableBeanFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.xml.XmlBeanDefinitionReader</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * {@link BeanFactory} IoC容器示例</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeanFactoryIoCContainerDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//创建 BeanFactory 容器</span>
        <span class="n">DefaultListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultListableBeanFactory</span><span class="p">();</span>
        <span class="n">XmlBeanDefinitionReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">XmlBeanDefinitionReader</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>
        <span class="c1">//XML配置文件路径</span>
        <span class="n">String</span> <span class="n">configLocation</span> <span class="o">=</span> <span class="s">&quot;classpath:/dependency-lookup.xml&quot;</span><span class="p">;</span>
        <span class="c1">//加载配置</span>
        <span class="kt">int</span> <span class="n">beanDefinitionsCount</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="na">loadBeanDefinitions</span><span class="p">(</span><span class="n">configLocation</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Bean count: &quot;</span> <span class="o">+</span> <span class="n">beanDefinitionsCount</span><span class="p">);</span>
        <span class="c1">//依赖查找集合对象</span>
        <span class="n">lookupByCollectionType</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">,</span> <span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">lookupByCollectionType</span><span class="p">(</span><span class="n">BeanFactory</span> <span class="n">beanFactory</span><span class="p">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">beanFactory</span> <span class="k">instanceof</span> <span class="n">ListableBeanFactory</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ListableBeanFactory</span> <span class="n">listableBeanFactory</span> <span class="o">=</span> <span class="p">(</span><span class="n">ListableBeanFactory</span><span class="p">)</span> <span class="n">beanFactory</span><span class="p">;</span>
            <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="o">?&gt;</span> <span class="n">collection</span> <span class="o">=</span> <span class="n">listableBeanFactory</span><span class="p">.</span><span class="na">getBeansOfType</span><span class="p">(</span><span class="n">clazz</span><span class="p">);</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Lookup By collection: &quot;</span> <span class="o">+</span> <span class="n">collection</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>沿用之前的配置文件<code>dependency-lookup.xml</code>，运行程序，得到输出：
<div class="highlight"><pre><span></span><code>Bean count: 4
Lookup By collection: {person=Person{name=&#39;Tom&#39;, age=18}, person2=Person{name=&#39;Jerry&#39;, age=18}, admin=Administrator{userName=&#39;tom@abc.com&#39;, password=&#39;123456&#39;} Person{name=&#39;Tom&#39;, age=18}}
</code></pre></div></p>
<p>使用<code>BeanFactory</code>就是典型的IoC容器，没有事件，资源等特性。</p>
<p>上面示例一直使用的是基于XML的配置信息，下面使用基于注解配置的实现，使用<code>AnnotationConfigApplicationContext</code>：
<div class="highlight"><pre><span></span><code><span class="n">AnnotationConfigApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnotationConfigApplicationContext</span><span class="p">();</span>
</code></pre></div></p>
<p>创建好<code>ApplicationContext</code>对象后，需要注册配置类，使用<code>register(Class&lt;?&gt;... componentClasses)</code>方法即可将配置类进行注册。配置好后，再调用<code>refresh()</code>方法即可初始化IoC容器，完整示例如下：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.ioc.overview.container</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.ioc.overview.domain.Person</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.BeanFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.ListableBeanFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.ApplicationContext</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.AnnotationConfigApplicationContext</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 注解能力 {@link ApplicationContext} IoC容器</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnnotationApplicationContextIoCContainerDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//创建 ApplicationContext</span>
        <span class="n">AnnotationConfigApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnotationConfigApplicationContext</span><span class="p">();</span>
        <span class="c1">//将当前类作为配置类</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">AnnotationApplicationContextIoCContainerDemo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="c1">//启动应用上下文</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">refresh</span><span class="p">();</span>
        <span class="c1">//依赖查找集合对象</span>
        <span class="n">lookupByCollectionType</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">,</span> <span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 通过Java注解的方式定义Bean</span>
<span class="cm">     */</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">Person</span> <span class="nf">person</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="p">();</span>
        <span class="n">person</span><span class="p">.</span><span class="na">setName</span><span class="p">(</span><span class="s">&quot;Leo&quot;</span><span class="p">);</span>
        <span class="n">person</span><span class="p">.</span><span class="na">setAge</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">person</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">lookupByCollectionType</span><span class="p">(</span><span class="n">BeanFactory</span> <span class="n">beanFactory</span><span class="p">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">beanFactory</span> <span class="k">instanceof</span> <span class="n">ListableBeanFactory</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ListableBeanFactory</span> <span class="n">listableBeanFactory</span> <span class="o">=</span> <span class="p">(</span><span class="n">ListableBeanFactory</span><span class="p">)</span> <span class="n">beanFactory</span><span class="p">;</span>
            <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="o">?&gt;</span> <span class="n">collection</span> <span class="o">=</span> <span class="n">listableBeanFactory</span><span class="p">.</span><span class="na">getBeansOfType</span><span class="p">(</span><span class="n">clazz</span><span class="p">);</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Lookup By collection: &quot;</span> <span class="o">+</span> <span class="n">collection</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>这里通过注解的方式定义Bean，执行程序，即可得到：
<div class="highlight"><pre><span></span><code>Lookup By collection: {person=Person{name=&#39;Leo&#39;, age=20}}
</code></pre></div></p>
<h3 id="56-spring-ioc">5.6 Spring IoC容器的生命周期<a class="headerlink" href="#56-spring-ioc" title="Permanent link">&para;</a></h3>
<p>Spring IoC容器的生命周期简单分为以下过程：</p>
<ul>
<li>启动</li>
<li>运行</li>
<li>停止</li>
</ul>
<p>上节的示例中，使用了<code>applicationContext.refresh()</code>方法来启动应用上下文，对应了启动过程，该方法在<code>AbstractApplicationContext</code>中实现：
(以下代码基于Spring Framework <strong>5.2.8.RELEASE</strong>)
<div class="highlight"><pre><span></span><code><span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">refresh</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">BeansException</span><span class="p">,</span> <span class="n">IllegalStateException</span> <span class="p">{</span>
        <span class="kd">synchronized</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">startupShutdownMonitor</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Prepare this context for refreshing.</span>
            <span class="n">prepareRefresh</span><span class="p">();</span>

            <span class="c1">// Tell the subclass to refresh the internal bean factory.</span>
            <span class="n">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">obtainFreshBeanFactory</span><span class="p">();</span>

            <span class="c1">// Prepare the bean factory for use in this context.</span>
            <span class="n">prepareBeanFactory</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>

            <span class="k">try</span> <span class="p">{</span>
                <span class="c1">// Allows post-processing of the bean factory in context subclasses.</span>
                <span class="n">postProcessBeanFactory</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>

                <span class="c1">// Invoke factory processors registered as beans in the context.</span>
                <span class="n">invokeBeanFactoryPostProcessors</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>

                <span class="c1">// Register bean processors that intercept bean creation.</span>
                <span class="n">registerBeanPostProcessors</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>

                <span class="c1">// Initialize message source for this context.</span>
                <span class="n">initMessageSource</span><span class="p">();</span>

                <span class="c1">// Initialize event multicaster for this context.</span>
                <span class="n">initApplicationEventMulticaster</span><span class="p">();</span>

                <span class="c1">// Initialize other special beans in specific context subclasses.</span>
                <span class="n">onRefresh</span><span class="p">();</span>

                <span class="c1">// Check for listener beans and register them.</span>
                <span class="n">registerListeners</span><span class="p">();</span>

                <span class="c1">// Instantiate all remaining (non-lazy-init) singletons.</span>
                <span class="n">finishBeanFactoryInitialization</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>

                <span class="c1">// Last step: publish corresponding event.</span>
                <span class="n">finishRefresh</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">catch</span> <span class="p">(</span><span class="n">BeansException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isWarnEnabled</span><span class="p">())</span> <span class="p">{</span>
                    <span class="n">logger</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;Exception encountered during context initialization - &quot;</span> <span class="o">+</span>
                            <span class="s">&quot;cancelling refresh attempt: &quot;</span> <span class="o">+</span> <span class="n">ex</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="c1">// Destroy already created singletons to avoid dangling resources.</span>
                <span class="n">destroyBeans</span><span class="p">();</span>

                <span class="c1">// Reset &#39;active&#39; flag.</span>
                <span class="n">cancelRefresh</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>

                <span class="c1">// Propagate exception to caller.</span>
                <span class="k">throw</span> <span class="n">ex</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">finally</span> <span class="p">{</span>
                <span class="c1">// Reset common introspection caches in Spring&#39;s core, since we</span>
                <span class="c1">// might not ever need metadata for singleton beans anymore...</span>
                <span class="n">resetCommonCaches</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></p>
<p>整个逻辑放在<code>synchronized</code>同步块中进行。</p>
<ul>
<li>
<p><code>prepareRefresh()</code>方法做一些启动前的准备工作：记录启动时间、设置状态、初始化<code>Environment</code>属性并校验，准备启动前监听器等。</p>
</li>
<li>
<p><code>obtainFreshBeanFactory()</code>方法为获取<code>BeanFactory</code>，主要方法由子类实现。其中<code>AbstractRefreshableApplicationContext</code>的实现为：
<div class="highlight"><pre><span></span><code>    <span class="cm">/**</span>
<span class="cm">     * This implementation performs an actual refresh of this context&#39;s underlying</span>
<span class="cm">     * bean factory, shutting down the previous bean factory (if any) and</span>
<span class="cm">     * initializing a fresh bean factory for the next phase of the context&#39;s lifecycle.</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">refreshBeanFactory</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">BeansException</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">hasBeanFactory</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">destroyBeans</span><span class="p">();</span>
            <span class="n">closeBeanFactory</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">DefaultListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">createBeanFactory</span><span class="p">();</span>
            <span class="n">beanFactory</span><span class="p">.</span><span class="na">setSerializationId</span><span class="p">(</span><span class="n">getId</span><span class="p">());</span>
            <span class="n">customizeBeanFactory</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>
            <span class="n">loadBeanDefinitions</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="na">beanFactory</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">ApplicationContextException</span><span class="p">(</span><span class="s">&quot;I/O error parsing bean definition source for &quot;</span> <span class="o">+</span> <span class="n">getDisplayName</span><span class="p">(),</span> <span class="n">ex</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="kd">protected</span> <span class="n">DefaultListableBeanFactory</span> <span class="nf">createBeanFactory</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">DefaultListableBeanFactory</span><span class="p">(</span><span class="n">getInternalParentBeanFactory</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">ConfigurableListableBeanFactory</span> <span class="nf">getBeanFactory</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">DefaultListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">beanFactory</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">beanFactory</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;BeanFactory not initialized or already closed - &quot;</span> <span class="o">+</span>
                    <span class="s">&quot;call &#39;refresh&#39; before accessing beans via the ApplicationContext&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">beanFactory</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
该类中的<code>beanFactory</code>使用<code>volatile</code>关键字修饰，老版本中也是使用<code>synchronized</code>加锁。</p>
</li>
<li>
<p><code>prepareBeanFactory(beanFactory)</code>方法，注册了一些基本的内建依赖，比如<code>BeanFactory</code>和<code>Environment</code>等其他操作。</p>
</li>
<li>
<p><code>postProcessBeanFactory(beanFactory)</code>方法由子类具体实现，<code>invokeBeanFactoryPostProcessors(beanFactory)</code>就是进行调用：
<div class="highlight"><pre><span></span><code>    <span class="cm">/**</span>
<span class="cm">     * Modify the application context&#39;s internal bean factory after its standard</span>
<span class="cm">     * initialization. All bean definitions will have been loaded, but no beans</span>
<span class="cm">     * will have been instantiated yet. This allows for registering special</span>
<span class="cm">     * BeanPostProcessors etc in certain ApplicationContext implementations.</span>
<span class="cm">     * @param beanFactory the bean factory used by the application context</span>
<span class="cm">     */</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">postProcessBeanFactory</span><span class="p">(</span><span class="n">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">invokeBeanFactoryPostProcessors</span><span class="p">(</span><span class="n">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PostProcessorRegistrationDelegate</span><span class="p">.</span><span class="na">invokeBeanFactoryPostProcessors</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">,</span> <span class="n">getBeanFactoryPostProcessors</span><span class="p">());</span>

        <span class="c1">// Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime</span>
        <span class="c1">// (e.g. through an @Bean method registered by ConfigurationClassPostProcessor)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">beanFactory</span><span class="p">.</span><span class="na">getTempClassLoader</span><span class="p">()</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">beanFactory</span><span class="p">.</span><span class="na">containsBean</span><span class="p">(</span><span class="n">LOAD_TIME_WEAVER_BEAN_NAME</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">beanFactory</span><span class="p">.</span><span class="na">addBeanPostProcessor</span><span class="p">(</span><span class="k">new</span> <span class="n">LoadTimeWeaverAwareProcessor</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">));</span>
            <span class="n">beanFactory</span><span class="p">.</span><span class="na">setTempClassLoader</span><span class="p">(</span><span class="k">new</span> <span class="n">ContextTypeMatchClassLoader</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">.</span><span class="na">getBeanClassLoader</span><span class="p">()));</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><code>registerBeanPostProcessors(beanFactory)</code>就是注册Bean的后置处理器。</p>
</li>
<li>
<p><code>initMessageSource()</code>是对国际化的支持，初始化<code>Message</code>资源，体现了<code>ApplicationContext</code>和<code>BeanFactory</code>的不同。</p>
</li>
<li>
<p><code>initApplicationEventMulticaster()</code>初始化应用事件广播，具备事件特性。</p>
</li>
<li>
<p><code>onRefresh()</code>是初始化特定上下文中的特定<code>bean</code>。</p>
</li>
<li>
<p><code>registerListeners()</code>是注册监听器。</p>
</li>
<li>
<p><code>finishBeanFactoryInitialization(beanFactory)</code>实例化一些单例对象并完成<code>BeanFactory</code>的初始化。</p>
</li>
<li>
<p><code>finishRefresh()</code>完成初始化并发布对应事件。</p>
</li>
</ul>
<p><code>ApplicationContext</code>的初始化工作较为复杂，这里只是简单介绍了其中各个步骤，其具体内容需要深入了解。</p>
<p>停止操作可以调用如下方法完成：
<div class="highlight"><pre><span></span><code>        <span class="c1">//关闭应用上下文</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
</code></pre></div></p>
<p><code>close()</code>方法也在<code>AbstractApplicationContext</code>中定义：
<div class="highlight"><pre><span></span><code>    <span class="cm">/**</span>
<span class="cm">     * Close this application context, destroying all beans in its bean factory.</span>
<span class="cm">     * &lt;p&gt;Delegates to {@code doClose()} for the actual closing procedure.</span>
<span class="cm">     * Also removes a JVM shutdown hook, if registered, as it&#39;s not needed anymore.</span>
<span class="cm">     * @see #doClose()</span>
<span class="cm">     * @see #registerShutdownHook()</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">synchronized</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">startupShutdownMonitor</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">doClose</span><span class="p">();</span>
            <span class="c1">// If we registered a JVM shutdown hook, we don&#39;t need it anymore now:</span>
            <span class="c1">// We&#39;ve already explicitly closed the context.</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">shutdownHook</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">removeShutdownHook</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">shutdownHook</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">catch</span> <span class="p">(</span><span class="n">IllegalStateException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// ignore - VM is already shutting down</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></p>
<p>其中Spring Framework的关闭操作在<code>doClose()</code>方法中完成，其中主要是以下3个方法：
<div class="highlight"><pre><span></span><code>            <span class="p">...</span>
            <span class="c1">// Destroy all cached singletons in the context&#39;s BeanFactory.</span>
            <span class="n">destroyBeans</span><span class="p">();</span>

            <span class="c1">// Close the state of this context itself.</span>
            <span class="n">closeBeanFactory</span><span class="p">();</span>

            <span class="c1">// Let subclasses do some final clean-up if they wish...</span>
            <span class="n">onClose</span><span class="p">();</span>
            <span class="p">...</span>
</code></pre></div></p>
<p>也就是销毁所有的Bean，关闭<code>BeanFactory</code>，并且给子类留有特定关闭逻辑的<code>onClose()</code>方法。</p>
<p>其余内容可以具体参考源代码。</p>
<p>(不同版本之间的代码实现会有差别)</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../.." title="Home" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Home
              </div>
            </div>
          </a>
        
        
          <a href="../02-spring-beans/" title="Spring Beans" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Spring Beans
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2020 Nan Lei
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.d1f5a259.min.js"></script>
      <script src="../../assets/javascripts/bundle.d5fec882.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: ["tabs"],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.fae956e7.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="../../javascripts/extra.js"></script>
      
    
  </body>
</html>