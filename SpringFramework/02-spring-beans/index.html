


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Tech Notes">
      
      
      
        <meta name="author" content="Nan Lei">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.7">
    
    
      
        <title>Spring Beans - Tech Notes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.b8ac9624.min.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/palette.28f3ef9a.min.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=:300,400,400i,700%7C&display=fallback">
        <style>body,input{font-family:"",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#1-spring-beandefinition" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-announce">
          <div class="md-announce__inner md-grid md-typeset">
            
  <a href="mailto:nanlei1987@gmail.com">
    Mail to <strong>nanlei1987@gmail.com</strong> for your queries.
  </a>

          </div>
        </aside>
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="Tech Notes" class="md-header-nav__button md-logo" aria-label="Tech Notes">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Tech Notes
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Spring Beans
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/nanlei/my-notes/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
          

  

<nav class="md-tabs md-tabs--active" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../.." class="md-tabs__link">
        Home
      </a>
    
  </li>

      
        
  
  
    
    
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../01-spring-ioc/" class="md-tabs__link md-tabs__link--active">
          Framework
        </a>
      
    </li>
  

  

  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../DataBase/MySQL/master-slave/" class="md-tabs__link">
          DataBase
        </a>
      
    </li>
  

  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../DevOps/devops-centos/" class="md-tabs__link">
          DevOps
        </a>
      
    </li>
  

  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../about/" class="md-tabs__link">
          About
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Tech Notes" class="md-nav__button md-logo" aria-label="Tech Notes">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Tech Notes
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/nanlei/my-notes/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Framework
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Framework" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Framework
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-1" type="checkbox" id="nav-2-1" checked>
    
    <label class="md-nav__link" for="nav-2-1">
      Spring Framework
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Spring Framework" data-md-level="2">
      <label class="md-nav__title" for="nav-2-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Spring Framework
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-1-1" type="checkbox" id="nav-2-1-1" checked>
    
    <label class="md-nav__link" for="nav-2-1-1">
      IoC
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="IoC" data-md-level="3">
      <label class="md-nav__title" for="nav-2-1-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        IoC
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../01-spring-ioc/" title="Spring IoC" class="md-nav__link">
      Spring IoC
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Spring Beans
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Spring Beans" class="md-nav__link md-nav__link--active">
      Spring Beans
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-spring-beandefinition" class="md-nav__link">
    1. Spring BeanDefinition
  </a>
  
    <nav class="md-nav" aria-label="1. Spring BeanDefinition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-beandefinitionbuilder" class="md-nav__link">
    1.1 通过BeanDefinitionBuilder构建
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-abstractbeandefinition" class="md-nav__link">
    1.2 通过AbstractBeanDefinition以及子类构建
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-spring-bean" class="md-nav__link">
    2. Spring Bean的名称
  </a>
  
    <nav class="md-nav" aria-label="2. Spring Bean的名称">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-bean-beannamegenerator" class="md-nav__link">
    2.1 Bean 名称生成器 BeanNameGenerator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-bean" class="md-nav__link">
    2.2 Bean的别名
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-spring-bean" class="md-nav__link">
    3. 注册Spring Bean
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-spring-bean" class="md-nav__link">
    4. 实例化Spring Bean
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-spring-bean" class="md-nav__link">
    5. 初始化Spring Bean
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-spring-bean" class="md-nav__link">
    6. 延迟初始化Spring Bean
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-spring-bean" class="md-nav__link">
    7. 销毁Spring Bean
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-1-2" type="checkbox" id="nav-2-1-2">
    
    <label class="md-nav__link" for="nav-2-1-2">
      Annotation Driven
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Annotation Driven" data-md-level="3">
      <label class="md-nav__title" for="nav-2-1-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Annotation Driven
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../spring-annotation-stereotype-annotation/" title="Stereotype Annotation" class="md-nav__link">
      Stereotype Annotation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../spring-annotation-composed-annotation/" title="Composed Annotation" class="md-nav__link">
      Composed Annotation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../spring-annotation-attributes/" title="Annotation Attributes" class="md-nav__link">
      Annotation Attributes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-2" type="checkbox" id="nav-2-2">
    
    <label class="md-nav__link" for="nav-2-2">
      Spring Boot
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Spring Boot" data-md-level="2">
      <label class="md-nav__title" for="nav-2-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Spring Boot
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-2-1" type="checkbox" id="nav-2-2-1">
    
    <label class="md-nav__link" for="nav-2-2-1">
      Notes
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Notes" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Notes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../SpringBoot/01-spring-boot-application/" title="Standalone Application" class="md-nav__link">
      Standalone Application
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../SpringBoot/02-spring-boot-maven-dependency/" title="Maven Dependencies" class="md-nav__link">
      Maven Dependencies
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../SpringBoot/03-spring-boot-embedded-web-server/" title="Embedded Web Server" class="md-nav__link">
      Embedded Web Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../SpringBoot/04-spring-boot-understanding-auto-config/" title="Understanding Auto-Configuration" class="md-nav__link">
      Understanding Auto-Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../SpringBoot/05-spring-boot-understanding-prod-ready/" title="Understanding Production-Ready" class="md-nav__link">
      Understanding Production-Ready
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-2-2" type="checkbox" id="nav-2-2-2">
    
    <label class="md-nav__link" for="nav-2-2-2">
      Samples
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Samples" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Samples
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../SpringBoot/app-shardingsphere-master-slave-mysql/" title="Shardingsphere master-slave with MySQL" class="md-nav__link">
      Shardingsphere master-slave with MySQL
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      DataBase
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="DataBase" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        DataBase
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1" type="checkbox" id="nav-3-1">
    
    <label class="md-nav__link" for="nav-3-1">
      MySQL
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="MySQL" data-md-level="2">
      <label class="md-nav__title" for="nav-3-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        MySQL
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../DataBase/MySQL/master-slave/" title="Master Slave" class="md-nav__link">
      Master Slave
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2">
    
    <label class="md-nav__link" for="nav-3-2">
      MongoDB
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="MongoDB" data-md-level="2">
      <label class="md-nav__title" for="nav-3-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        MongoDB
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../DataBase/MongoDB/replica-set/" title="Replica Set" class="md-nav__link">
      Replica Set
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      DevOps
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="DevOps" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        DevOps
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-1" type="checkbox" id="nav-4-1">
    
    <label class="md-nav__link" for="nav-4-1">
      Linux
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Linux" data-md-level="2">
      <label class="md-nav__title" for="nav-4-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Linux
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../DevOps/devops-centos/" title="CentOS" class="md-nav__link">
      CentOS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../DevOps/devops-ubuntu/" title="Ubuntu" class="md-nav__link">
      Ubuntu
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-2" type="checkbox" id="nav-4-2">
    
    <label class="md-nav__link" for="nav-4-2">
      Docker
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Docker" data-md-level="2">
      <label class="md-nav__title" for="nav-4-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Docker
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../DevOps/docker/" title="Basic" class="md-nav__link">
      Basic
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      About
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="About" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        About
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../about/" title="Who Am I" class="md-nav__link">
      Who Am I
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-spring-beandefinition" class="md-nav__link">
    1. Spring BeanDefinition
  </a>
  
    <nav class="md-nav" aria-label="1. Spring BeanDefinition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-beandefinitionbuilder" class="md-nav__link">
    1.1 通过BeanDefinitionBuilder构建
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-abstractbeandefinition" class="md-nav__link">
    1.2 通过AbstractBeanDefinition以及子类构建
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-spring-bean" class="md-nav__link">
    2. Spring Bean的名称
  </a>
  
    <nav class="md-nav" aria-label="2. Spring Bean的名称">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-bean-beannamegenerator" class="md-nav__link">
    2.1 Bean 名称生成器 BeanNameGenerator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-bean" class="md-nav__link">
    2.2 Bean的别名
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-spring-bean" class="md-nav__link">
    3. 注册Spring Bean
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-spring-bean" class="md-nav__link">
    4. 实例化Spring Bean
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-spring-bean" class="md-nav__link">
    5. 初始化Spring Bean
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-spring-bean" class="md-nav__link">
    6. 延迟初始化Spring Bean
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-spring-bean" class="md-nav__link">
    7. 销毁Spring Bean
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/nanlei/my-notes/edit/master/docs/SpringFramework/02-spring-beans.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                  <h1>Spring Beans</h1>
                
                <h3 align="center"><b>Spring Beans 基础</b></h3>

<h2 id="1-spring-beandefinition">1. Spring <code>BeanDefinition</code><a class="headerlink" href="#1-spring-beandefinition" title="Permanent link">&para;</a></h2>
<p><code>BeanDefinition</code>是Spring Framework中定义Bean的配置元信息接口(<code>org.springframework.beans.factory.config.BeanDefinition</code>)，包含：</p>
<ul>
<li>Bean的类名(类全名/完全限定名)</li>
<li>Bean行为元素(作用域，自动绑定模式，生命周期回调等)</li>
<li>其他Bean引用(依赖dependencies)</li>
<li>配置设置(Bean属性properties)</li>
</ul>
<p><code>BeanDefinition</code>的构建主要通过以下方式进行：</p>
<ul>
<li><code>BeanDefinitionBuilder</code></li>
<li><code>AbstractBeanDefinition</code>(本身实现了<code>BeanDefinition</code>接口)以及子类</li>
</ul>
<p><code>BeanDefinition</code>的元信息包括：</p>
<ul>
<li>Bean的类全名(必须是具体类，不能是接口或抽象类)：<code>class</code></li>
<li>Bean的名称：<code>id</code>/<code>name</code></li>
<li>Bean的作用域(<code>singleton</code>，<code>prototype</code>)：<code>scope</code></li>
<li>Bean的构造器参数(用于依赖注入)：<code>constructor-arg</code></li>
<li>Bean的属性设置(用于依赖注入)：<code>property</code></li>
<li>Bean的自动绑定模式(<code>byName</code>，<code>byType</code>等)：<code>autowire</code></li>
<li>Bean的延迟初始化模式(<code>true</code>/<code>false</code>)：<code>lazy-init</code></li>
<li>初始化回调方法：<code>init-method</code></li>
<li>销毁回调方法：<code>destroy-method</code></li>
</ul>
<h3 id="11-beandefinitionbuilder">1.1 通过<code>BeanDefinitionBuilder</code>构建<a class="headerlink" href="#11-beandefinitionbuilder" title="Permanent link">&para;</a></h3>
<p><code>BeanDefinitionBuilder</code>(<code>org.springframework.beans.factory.support.BeanDefinitionBuilder</code>)是一个构建器模式的类，提供了一系列的静态方法来辅助构建<code>BeanDefinition</code>。
<img alt="" src="../img/spring.beans.bean.definition.builder.png" /></p>
<p>首先创建<code>BeanDefinitionBuilder</code>对象，按照Bean的类型来构建：
<div class="highlight"><pre><span></span><code><span class="c1">//通过BeanDefinitionBuilder构建</span>
<span class="n">BeanDefinitionBuilder</span> <span class="n">beanDefinitionBuilder</span> <span class="o">=</span> <span class="n">BeanDefinitionBuilder</span><span class="p">.</span><span class="na">genericBeanDefinition</span><span class="p">(</span><span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</code></pre></div></p>
<p>获取到<code>BeanDefinitionBuilder</code>对象后，进行属性设置：
<div class="highlight"><pre><span></span><code><span class="c1">//属性设置</span>
<span class="n">beanDefinitionBuilder</span><span class="p">.</span><span class="na">addPropertyValue</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;Tom&quot;</span><span class="p">).</span><span class="na">addPropertyValue</span><span class="p">(</span><span class="s">&quot;age&quot;</span><span class="p">,</span> <span class="mi">22</span><span class="p">);</span>
</code></pre></div></p>
<p>构建完成，获取<code>BeanDefinition</code>对象：
<div class="highlight"><pre><span></span><code><span class="c1">//获取BeanDefinition实例</span>
<span class="n">BeanDefinition</span> <span class="n">beanDefinition</span> <span class="o">=</span> <span class="n">beanDefinitionBuilder</span><span class="p">.</span><span class="na">getBeanDefinition</span><span class="p">();</span>
</code></pre></div></p>
<p>此时的<code>beanDefinition</code>还可以自定义修改，并非Bean的最终状态，因为这里只是获取<code>BeanDefinition</code>，没有注册到IoC容器中。</p>
<h3 id="12-abstractbeandefinition">1.2 通过<code>AbstractBeanDefinition</code>以及子类构建<a class="headerlink" href="#12-abstractbeandefinition" title="Permanent link">&para;</a></h3>
<p>抽象类<code>AbstractBeanDefinition</code>实现了<code>BeanDefinition</code>接口，可以使用其子类进行<code>BeanDefinition</code>构建。</p>
<p>当前Spring版本(<strong>5.2.8.RELEASE</strong>)，<code>AbstractBeanDefinition</code>的实现类有以下几个：
<img alt="" src="../img/spring.beans.abstract.bean.definition.png" /></p>
<p>这里作为示例，使用<code>GenericBeanDefinition</code>进行构建：
<div class="highlight"><pre><span></span><code><span class="c1">//通过AbstractBeanDefinition以及子类构建</span>
<span class="n">GenericBeanDefinition</span> <span class="n">genericBeanDefinition</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GenericBeanDefinition</span><span class="p">();</span>
</code></pre></div></p>
<p>创建好对象，设置Bean的类型：
<div class="highlight"><pre><span></span><code><span class="c1">//设置Bean类型</span>
<span class="n">genericBeanDefinition</span><span class="p">.</span><span class="na">setBeanClass</span><span class="p">(</span><span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</code></pre></div></p>
<p>继续设置参数：
<div class="highlight"><pre><span></span><code><span class="c1">//通过MutablePropertyValues批量操作</span>
<span class="n">MutablePropertyValues</span> <span class="n">mutablePropertyValues</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MutablePropertyValues</span><span class="p">();</span>
<span class="n">mutablePropertyValues</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;Jerry&quot;</span><span class="p">).</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;age&quot;</span><span class="p">,</span> <span class="mi">22</span><span class="p">);</span>
</code></pre></div></p>
<p>这里设置参数的方法和使用<code>BeanDefinitionBuilder</code>方式是一致的，在<code>BeanDefinitionBuilder</code>中，其设置属性的方法为：
<div class="highlight"><pre><span></span><code>    <span class="kd">public</span> <span class="n">BeanDefinitionBuilder</span> <span class="nf">addPropertyValue</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="nd">@Nullable</span> <span class="n">Object</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">beanDefinition</span><span class="p">.</span><span class="na">getPropertyValues</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></p>
<p>此处<code>getPropertyValues()</code>返回的就是<code>MutablePropertyValues</code>类型的对象。</p>
<p>最后将属性设置到<code>BeanDefinition</code>对象中：
<div class="highlight"><pre><span></span><code><span class="n">genericBeanDefinition</span><span class="p">.</span><span class="na">setPropertyValues</span><span class="p">(</span><span class="n">mutablePropertyValues</span><span class="p">);</span>
</code></pre></div></p>
<p>和上面的<code>BeanDefinitionBuilder</code>示例一样，此时也没有将其注册到IoC容器中。</p>
<h2 id="2-spring-bean">2. Spring Bean的名称<a class="headerlink" href="#2-spring-bean" title="Permanent link">&para;</a></h2>
<p>Spring Bean可以拥有一个或者多个标识符，但在 <strong>Bean的所在容器</strong> 中，标识符必须是唯一的。通常情况下，一个Bean只有一个标识符，如果需要额外的，可以使用别名(Alias)来扩展。</p>
<p>在使用XML作为配置文件的实例中，可以使用<code>id</code>或者<code>name</code>属性来定义Bean的标识符。若要引入Bean的别名，需要使用<code>name</code>属性，并用英文字符的逗号(<code>,</code>)或者分号(<code>;</code>)来间隔名称，比如：
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans</span>
<span class="s">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">name=</span><span class="s">&quot;person,tom&quot;</span> <span class="na">class=</span><span class="s">&quot;deep.in.spring.ioc.overview.domain.Person&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">value=</span><span class="s">&quot;Tom&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;age&quot;</span> <span class="na">value=</span><span class="s">&quot;18&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">name=</span><span class="s">&quot;person2;jerry&quot;</span> <span class="na">class=</span><span class="s">&quot;deep.in.spring.ioc.overview.domain.Person&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">value=</span><span class="s">&quot;Jerry&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;age&quot;</span> <span class="na">value=</span><span class="s">&quot;18&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></p>
<p>获取Bean的时候可以使用如下代码：
<div class="highlight"><pre><span></span><code><span class="n">beanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;person&quot;</span><span class="p">);</span>
<span class="n">beanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;jerry&quot;</span><span class="p">);</span>
</code></pre></div></p>
<p>Bean的<code>id</code>或<code>name</code>属性并不是必须的，如果留空，容器会为Bean自动生成一个唯一的名称，例如将上面XML配置文件中的Bean的<code>name</code>属性删除，改为：
<div class="highlight"><pre><span></span><code>    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;deep.in.spring.ioc.overview.domain.Person&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">value=</span><span class="s">&quot;Tom&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;age&quot;</span> <span class="na">value=</span><span class="s">&quot;18&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;deep.in.spring.ioc.overview.domain.Person&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">value=</span><span class="s">&quot;Jerry&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;age&quot;</span> <span class="na">value=</span><span class="s">&quot;18&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
</code></pre></div></p>
<p>编写引导代码：
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">deep.in.spring.ioc.overview.domain.Person</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.BeanFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.ListableBeanFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.ClassPathXmlApplicationContext</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DependencyLookupDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">BeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathXmlApplicationContext</span><span class="p">(</span><span class="s">&quot;classpath:/dependency-lookup.xml&quot;</span><span class="p">);</span>
        <span class="n">lookupByCollectionType</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">,</span> <span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">lookupByCollectionType</span><span class="p">(</span><span class="n">BeanFactory</span> <span class="n">beanFactory</span><span class="p">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">beanFactory</span> <span class="k">instanceof</span> <span class="n">ListableBeanFactory</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ListableBeanFactory</span> <span class="n">listableBeanFactory</span> <span class="o">=</span> <span class="p">(</span><span class="n">ListableBeanFactory</span><span class="p">)</span> <span class="n">beanFactory</span><span class="p">;</span>
            <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="o">?&gt;</span> <span class="n">collection</span> <span class="o">=</span> <span class="n">listableBeanFactory</span><span class="p">.</span><span class="na">getBeansOfType</span><span class="p">(</span><span class="n">clazz</span><span class="p">);</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Lookup By collection: &quot;</span> <span class="o">+</span> <span class="n">collection</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>运行程序，可以得到：
<div class="highlight"><pre><span></span><code>Lookup By collection: {deep.in.spring.ioc.overview.domain.Person#0=Person{name=&#39;Tom&#39;, age=18}, deep.in.spring.ioc.overview.domain.Person#1=Person{name=&#39;Jerry&#39;, age=18}}
</code></pre></div></p>
<p><code>deep.in.spring.ioc.overview.domain.Person#0</code>和<code>deep.in.spring.ioc.overview.domain.Person#1</code>就是容器自动生成的Bean的名称。</p>
<p>尽管Bean的命名没有限制，作为代码规约，建议使用驼峰命名方式，也符合Java的命名约定。</p>
<h3 id="21-bean-beannamegenerator">2.1 <span id='bean-name-gen'>Bean 名称生成器 <code>BeanNameGenerator</code></span><a class="headerlink" href="#21-bean-beannamegenerator" title="Permanent link">&para;</a></h3>
<p>Spring Framework 2.0.3引入了Bean名称生成器<code>BeanNameGenerator</code>，其定义如下：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">org.springframework.beans.factory.support</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.config.BeanDefinition</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Strategy interface for generating bean names for bean definitions.</span>
<span class="cm"> *</span>
<span class="cm"> * @author Juergen Hoeller</span>
<span class="cm"> * @since 2.0.3</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BeanNameGenerator</span> <span class="p">{</span>
    <span class="cm">/**</span>
<span class="cm">     * Generate a bean name for the given bean definition.</span>
<span class="cm">     * @param definition the bean definition to generate a name for</span>
<span class="cm">     * @param registry the bean definition registry that the given definition</span>
<span class="cm">     * is supposed to be registered with</span>
<span class="cm">     * @return the generated bean name</span>
<span class="cm">     */</span>
    <span class="n">String</span> <span class="nf">generateBeanName</span><span class="p">(</span><span class="n">BeanDefinition</span> <span class="n">definition</span><span class="p">,</span> <span class="n">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></p>
<p>该接口只定义了一个方法，用于返回Bean的名称。</p>
<p>其实现类，有3个(<strong>5.2.8.RELEASE</strong> 版本)：
<img alt="" src="../img/spring.beans.name.generator.png" /></p>
<p>其中<code>FullyQualifiedAnnotationBeanNameGenerator</code>(Spring 5.2.3引入)继承自 <code>AnnotationBeanNameGenerator</code>，是其类全名的实现版本。</p>
<p>那么<code>BeanNameGenerator</code>的主要实现是2种，即<code>DefaultBeanNameGenerator</code>(默认实现)和<code>AnnotationBeanNameGenerator</code>(基于注解扫描的实现，Spring 2.5引入)。</p>
<p>Spring Framework官方文档对Bean的名称生成有解释，<a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-beanname">可以参考</a></p>
<blockquote>
<p>With component scanning in the classpath, Spring generates bean names for unnamed components, following the rules described earlier: essentially, taking the simple class name and turning its initial character to lower-case. However, in the (unusual) special case when there is more than one character and both the first and second characters are upper case, the original casing gets preserved. These are the same rules as defined by <code>java.beans.Introspector.decapitalize</code> (which Spring uses here).</p>
</blockquote>
<p><code>DefaultBeanNameGenerator</code>的实现比较简单：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">org.springframework.beans.factory.support</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.config.BeanDefinition</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Default implementation of the {@link BeanNameGenerator} interface, delegating to</span>
<span class="cm"> * {@link BeanDefinitionReaderUtils#generateBeanName(BeanDefinition, BeanDefinitionRegistry)}.</span>
<span class="cm"> *</span>
<span class="cm"> * @author Juergen Hoeller</span>
<span class="cm"> * @since 2.0.3</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultBeanNameGenerator</span> <span class="kd">implements</span> <span class="n">BeanNameGenerator</span> <span class="p">{</span>
    <span class="cm">/**</span>
<span class="cm">     * A convenient constant for a default {@code DefaultBeanNameGenerator} instance,</span>
<span class="cm">     * as used for {@link AbstractBeanDefinitionReader} setup.</span>
<span class="cm">     * @since 5.2</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">DefaultBeanNameGenerator</span> <span class="n">INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultBeanNameGenerator</span><span class="p">();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">generateBeanName</span><span class="p">(</span><span class="n">BeanDefinition</span> <span class="n">definition</span><span class="p">,</span> <span class="n">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">BeanDefinitionReaderUtils</span><span class="p">.</span><span class="na">generateBeanName</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">registry</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>生成Bean名称的方法借助外部工具类来完成：
<div class="highlight"><pre><span></span><code>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">GENERATED_BEAN_NAME_SEPARATOR</span> <span class="o">=</span> <span class="n">BeanFactoryUtils</span><span class="p">.</span><span class="na">GENERATED_BEAN_NAME_SEPARATOR</span><span class="p">;</span> <span class="c1">//#</span>
    <span class="p">...</span>
    <span class="cm">/**</span>
<span class="cm">     * Generate a bean name for the given bean definition, unique within the</span>
<span class="cm">     * given bean factory.</span>
<span class="cm">     * @param definition the bean definition to generate a bean name for</span>
<span class="cm">     * @param registry the bean factory that the definition is going to be</span>
<span class="cm">     * registered with (to check for existing bean names)</span>
<span class="cm">     * @param isInnerBean whether the given bean definition will be registered</span>
<span class="cm">     * as inner bean or as top-level bean (allowing for special name generation</span>
<span class="cm">     * for inner beans versus top-level beans)</span>
<span class="cm">     * @return the generated bean name</span>
<span class="cm">     * @throws BeanDefinitionStoreException if no unique name can be generated</span>
<span class="cm">     * for the given bean definition</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">generateBeanName</span><span class="p">(</span>
            <span class="n">BeanDefinition</span> <span class="n">definition</span><span class="p">,</span> <span class="n">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="p">,</span> <span class="kt">boolean</span> <span class="n">isInnerBean</span><span class="p">)</span>
            <span class="kd">throws</span> <span class="n">BeanDefinitionStoreException</span> <span class="p">{</span>

        <span class="n">String</span> <span class="n">generatedBeanName</span> <span class="o">=</span> <span class="n">definition</span><span class="p">.</span><span class="na">getBeanClassName</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">generatedBeanName</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">definition</span><span class="p">.</span><span class="na">getParentName</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">generatedBeanName</span> <span class="o">=</span> <span class="n">definition</span><span class="p">.</span><span class="na">getParentName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;$child&quot;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">definition</span><span class="p">.</span><span class="na">getFactoryBeanName</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">generatedBeanName</span> <span class="o">=</span> <span class="n">definition</span><span class="p">.</span><span class="na">getFactoryBeanName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;$created&quot;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">generatedBeanName</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanDefinitionStoreException</span><span class="p">(</span><span class="s">&quot;Unnamed bean definition specifies neither &quot;</span> <span class="o">+</span>
                    <span class="s">&quot;&#39;class&#39; nor &#39;parent&#39; nor &#39;factory-bean&#39; - can&#39;t generate bean name&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">isInnerBean</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Inner bean: generate identity hashcode suffix.</span>
            <span class="k">return</span> <span class="n">generatedBeanName</span> <span class="o">+</span> <span class="n">GENERATED_BEAN_NAME_SEPARATOR</span> <span class="o">+</span> <span class="n">ObjectUtils</span><span class="p">.</span><span class="na">getIdentityHexString</span><span class="p">(</span><span class="n">definition</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// Top-level bean: use plain class name with unique suffix if necessary.</span>
        <span class="k">return</span> <span class="n">uniqueBeanName</span><span class="p">(</span><span class="n">generatedBeanName</span><span class="p">,</span> <span class="n">registry</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Turn the given bean name into a unique bean name for the given bean factory,</span>
<span class="cm">     * appending a unique counter as suffix if necessary.</span>
<span class="cm">     * @param beanName the original bean name</span>
<span class="cm">     * @param registry the bean factory that the definition is going to be</span>
<span class="cm">     * registered with (to check for existing bean names)</span>
<span class="cm">     * @return the unique bean name to use</span>
<span class="cm">     * @since 5.1</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">uniqueBeanName</span><span class="p">(</span><span class="n">String</span> <span class="n">beanName</span><span class="p">,</span> <span class="n">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">id</span> <span class="o">=</span> <span class="n">beanName</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

        <span class="c1">// Increase counter until the id is unique.</span>
        <span class="n">String</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">beanName</span> <span class="o">+</span> <span class="n">GENERATED_BEAN_NAME_SEPARATOR</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">counter</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">registry</span><span class="p">.</span><span class="na">containsBeanDefinition</span><span class="p">(</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">counter</span><span class="o">++</span><span class="p">;</span>
            <span class="n">id</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">counter</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
</code></pre></div></p>
<p>根据获取到的Bean的类名，进行下一步处理。如果是内部类，就是<code>类名#哈希值</code>的格式，如果是常规类，就是<code>类名#从0开始的数字</code>格式。</p>
<p><code>AnnotationBeanNameGenerator</code>对Spring的模式注解(<code>org.springframework.stereotype.Component</code>及其派生注解)，<code>javax.annotation.ManagedBean</code>注解，<code>javax.inject.Named</code>有特殊处理。对其余注解也有默认规则，具体可以参考源码。</p>
<p>综上，Spring对Bean的名称生成有自己的实现，也就是不人为指定的时候，Bean也有自己的名称。自行指定可以使用<code>id</code>或者<code>name</code>属性(XML配置方式)，<code>value</code>属性(注解配置方式)。</p>
<h3 id="22-bean">2.2 Bean的别名<a class="headerlink" href="#22-bean" title="Permanent link">&para;</a></h3>
<p>Bean的别名(Alias)的用途：</p>
<ul>
<li>复用现有的BeanDefinition</li>
<li>使命名更佳场景化，比如</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">alias=</span><span class="s">&quot;moduleA-dataSource&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">alias=</span><span class="s">&quot;moduleB-dataSource&quot;</span><span class="nt">&gt;</span>
</code></pre></div>

<p>新建项目<code>spring-bean</code>，为了复用项目<code>ioc-overview</code>中的组件，其<code>pom.xml</code>中可以添加其依赖：
<div class="highlight"><pre><span></span><code>    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>deep-in-spring-boot<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>deep-in-spring-boot<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;relativePath&gt;</span>../pom.xml<span class="nt">&lt;/relativePath&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>spring-bean<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!-- Spring IoC 核心依赖 --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-context<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>5.2.8.RELEASE<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="c">&lt;!-- 复用ioc-overview --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>${groupId}<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>ioc-overview<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
</code></pre></div></p>
<p>在<code>resources</code>目录下新建<code>bean-definitions.xml</code>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans</span>
<span class="s">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- 导入第三方Spring XML配置文件  --&gt;</span>
    <span class="nt">&lt;import</span> <span class="na">resource=</span><span class="s">&quot;classpath:/dependency-lookup.xml&quot;</span><span class="nt">/&gt;</span>

    <span class="c">&lt;!-- 将Spring容器中的person Bean建立别名leo-person --&gt;</span>
    <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&quot;person&quot;</span> <span class="na">alias=</span><span class="s">&quot;leo-person&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></p>
<p>引入了<code>ioc-overview</code>后，其配置文件也会加入到<code>classpath</code>下，可以通过<code>import</code>来引入。</p>
<p>之后通过<code>alias</code>将<code>bean</code>起别名。</p>
<p>创建引导程序：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.bean.definition</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.ioc.overview.domain.Person</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.BeanFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.ClassPathXmlApplicationContext</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Bean 别名示例</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeanAliasDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//配置XML配置文件</span>
        <span class="c1">//启动Spring应用上下文</span>
        <span class="n">BeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathXmlApplicationContext</span><span class="p">(</span><span class="s">&quot;classpath:/bean-definitions.xml&quot;</span><span class="p">);</span>
        <span class="c1">//通过别名 获取曾用名person的bean</span>
        <span class="n">Person</span> <span class="n">leo</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;leo-person&quot;</span><span class="p">,</span> <span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;person&quot;</span><span class="p">,</span> <span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;leo-person == person: &quot;</span> <span class="o">+</span><span class="p">(</span><span class="n">leo</span><span class="o">==</span><span class="n">person</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>运行程序，可以得到：
<div class="highlight"><pre><span></span><code>leo-person == person: true
</code></pre></div></p>
<p>可以看到<code>bean</code>的别名的效果。</p>
<h2 id="3-spring-bean">3. 注册Spring Bean<a class="headerlink" href="#3-spring-bean" title="Permanent link">&para;</a></h2>
<p>Bean的注册方式有：</p>
<ul>
<li>XML配置(<code>&lt;bean name="..." .../&gt;</code>)</li>
<li>Java注解配置(<code>@Bean</code>，<code>@Component</code>，<code>@Import</code>)</li>
<li>Java API配置<ul>
<li>命名方式：<code>BeanDefinitionRegistry.registerBeanDefinition(String beanName, BeanDefinition beanDefinition)</code></li>
<li>非命名方式：<code>BeanDefinitionReaderUtils.registerWithGeneratedName(AbstractBeanDefinition definition, BeanDefinitionRegistry registry)</code></li>
<li>配置类方式：<code>AnnotatedBeanDefinitionReader.register(Class&lt;?&gt;... componentClasses)</code></li>
</ul>
</li>
</ul>
<p>XML方式已经多次使用，下面来看注解配置方式的实现：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.bean.definition</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.ioc.overview.domain.Person</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.AnnotationConfigApplicationContext</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Import</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 注解 BeanDefinition 示例</span>
<span class="cm"> */</span>
<span class="c1">//通过 @Import 方式</span>
<span class="nd">@Import</span><span class="p">(</span><span class="n">AnnotationBeanDefinitionDemo</span><span class="p">.</span><span class="na">Config</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnnotationBeanDefinitionDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//构建 ApplicationContext 容器</span>
        <span class="n">AnnotationConfigApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnotationConfigApplicationContext</span><span class="p">();</span>
        <span class="c1">//注册 Configuration 类(配置类)</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">Config</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="c1">//启动 Spring 应用上下文</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">refresh</span><span class="p">();</span>
        <span class="c1">//按照类型依赖查找</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Beans of Config: &quot;</span> <span class="o">+</span> <span class="n">applicationContext</span><span class="p">.</span><span class="na">getBeansOfType</span><span class="p">(</span><span class="n">Config</span><span class="p">.</span><span class="na">class</span><span class="p">));</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Beans of Person: &quot;</span> <span class="o">+</span> <span class="n">applicationContext</span><span class="p">.</span><span class="na">getBeansOfType</span><span class="p">(</span><span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">));</span>
        <span class="c1">//显式关闭 Spring 应用上下文</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 通过 @Component 方式</span>
<span class="cm">     */</span>
    <span class="nd">@Component</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="p">{</span>
        <span class="cm">/**</span>
<span class="cm">         * 通过 @Bean 方式</span>
<span class="cm">         */</span>
        <span class="nd">@Bean</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;person&quot;</span><span class="p">,</span> <span class="s">&quot;tom-person&quot;</span><span class="p">})</span>
        <span class="kd">public</span> <span class="n">Person</span> <span class="nf">person</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="p">();</span>
            <span class="n">person</span><span class="p">.</span><span class="na">setName</span><span class="p">(</span><span class="s">&quot;Tom&quot;</span><span class="p">);</span>
            <span class="n">person</span><span class="p">.</span><span class="na">setAge</span><span class="p">(</span><span class="mi">23</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">person</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>示例代码展示了3种注解配置的方式(<code>@Bean</code>，<code>@Component</code>，<code>@Import</code>)，通过注解配置上下文<code>AnnotationConfigApplicationContext</code>来加载。</p>
<p>运行程序，可以看到：
<div class="highlight"><pre><span></span><code>Beans of Config: {annotationBeanDefinitionDemo.Config=deep.in.spring.bean.definition.AnnotationBeanDefinitionDemo$Config@687080dc}
Beans of Person: {person=Person{name=&#39;Tom&#39;, age=23}}
</code></pre></div></p>
<p>虽然同时开启了3种Bean的注册方式，但每种类型的Bean只有1份，不会重复注册。</p>
<p>Java API方式实现Bean注册：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.bean.definition</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.ioc.overview.domain.Person</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.support.BeanDefinitionBuilder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.support.BeanDefinitionReaderUtils</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.support.BeanDefinitionRegistry</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.AnnotationConfigApplicationContext</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.StringUtils</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * API 注册 BeanDefinition 示例</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeanDefinitionDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//构建 ApplicationContext 容器</span>
        <span class="n">AnnotationConfigApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnotationConfigApplicationContext</span><span class="p">();</span>
        <span class="c1">//通过 BeanDefinition 注册 API 实现</span>
        <span class="c1">//命名方式</span>
        <span class="n">registerBeanDefinition</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">,</span> <span class="s">&quot;jerry-person&quot;</span><span class="p">,</span> <span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">prepareBeanProperty</span><span class="p">());</span>
        <span class="c1">//非命名方式</span>
        <span class="n">registerBeanDefinition</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">,</span> <span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">prepareBeanProperty</span><span class="p">());</span>
        <span class="c1">//启动 Spring 应用上下文</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">refresh</span><span class="p">();</span>
        <span class="c1">//按照类型依赖查找</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Person beans in Config: &quot;</span> <span class="o">+</span> <span class="n">applicationContext</span><span class="p">.</span><span class="na">getBeansOfType</span><span class="p">(</span><span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">));</span>
        <span class="c1">//显式关闭 Spring 应用上下文</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>

    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">registerBeanDefinition</span><span class="p">(</span><span class="n">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="p">,</span> <span class="n">String</span> <span class="n">beanName</span><span class="p">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanClass</span><span class="p">,</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">beanProperties</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">final</span> <span class="n">BeanDefinitionBuilder</span> <span class="n">beanDefinitionBuilder</span> <span class="o">=</span> <span class="n">BeanDefinitionBuilder</span><span class="p">.</span><span class="na">genericBeanDefinition</span><span class="p">(</span><span class="n">beanClass</span><span class="p">);</span>

        <span class="n">beanProperties</span><span class="p">.</span><span class="na">keySet</span><span class="p">().</span><span class="na">stream</span><span class="p">().</span><span class="na">forEach</span><span class="p">(</span><span class="n">key</span> <span class="o">-&gt;</span> <span class="p">{</span>
            <span class="n">beanDefinitionBuilder</span><span class="p">.</span><span class="na">addPropertyValue</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">beanProperties</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
        <span class="p">});</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">beanName</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">//命名方式注册 BeanDefinition</span>
            <span class="n">registry</span><span class="p">.</span><span class="na">registerBeanDefinition</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">beanDefinitionBuilder</span><span class="p">.</span><span class="na">getBeanDefinition</span><span class="p">());</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">//非命名方式注册 BeanDefinition</span>
            <span class="n">BeanDefinitionReaderUtils</span><span class="p">.</span><span class="na">registerWithGeneratedName</span><span class="p">(</span><span class="n">beanDefinitionBuilder</span><span class="p">.</span><span class="na">getBeanDefinition</span><span class="p">(),</span> <span class="n">registry</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">registerBeanDefinition</span><span class="p">(</span><span class="n">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="p">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanClass</span><span class="p">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">benProperties</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">registerBeanDefinition</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="n">beanClass</span><span class="p">,</span> <span class="n">benProperties</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">prepareBeanProperty</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">beanProperties</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="n">beanProperties</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;Jerry&quot;</span><span class="p">);</span>
        <span class="n">beanProperties</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;age&quot;</span><span class="p">,</span> <span class="mi">18</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">beanProperties</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>运行程序，得到结果：
<div class="highlight"><pre><span></span><code>Person beans in Config: {jerry-person=Person{name=&#39;Jerry&#39;, age=18}, deep.in.spring.ioc.overview.domain.Person#0=Person{name=&#39;Jerry&#39;, age=18}}
</code></pre></div></p>
<p>可以看出非命名方式时，Spring按照<a href="#bean-name-gen">Bean名称生成器</a>规则来生成名称。</p>
<p>注册Bean的时候也可以通过外部单体对象来进行：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.bean.definition</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.ioc.overview.domain.Person</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.config.SingletonBeanRegistry</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.AnnotationConfigApplicationContext</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SingletonBeanRegistrationDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//创建 BeanFactory 容器</span>
        <span class="n">AnnotationConfigApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnotationConfigApplicationContext</span><span class="p">();</span>
        <span class="c1">//创建外部Person对象</span>
        <span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="p">(</span><span class="s">&quot;Jerry&quot;</span><span class="p">,</span> <span class="mi">21</span><span class="p">);</span>
        <span class="c1">//注册外部单例对象</span>
        <span class="n">SingletonBeanRegistry</span> <span class="n">singletonBeanRegistry</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="p">.</span><span class="na">getBeanFactory</span><span class="p">();</span>
        <span class="n">singletonBeanRegistry</span><span class="p">.</span><span class="na">registerSingleton</span><span class="p">(</span><span class="s">&quot;person&quot;</span><span class="p">,</span> <span class="n">person</span><span class="p">);</span>
        <span class="c1">//启动 Spring 应用上下文</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">refresh</span><span class="p">();</span>
        <span class="c1">//通过依赖查找方式获取 Person</span>
        <span class="n">Person</span> <span class="n">personByLookup</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;person&quot;</span><span class="p">,</span> <span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;person == personByLookup: &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">person</span> <span class="o">==</span> <span class="n">personByLookup</span><span class="p">));</span>
        <span class="c1">//关闭 Spring 应用上下文</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>运行程序，得到结果：
<div class="highlight"><pre><span></span><code>person == personByLookup: true
</code></pre></div></p>
<h2 id="4-spring-bean">4. 实例化Spring Bean<a class="headerlink" href="#4-spring-bean" title="Permanent link">&para;</a></h2>
<p>Bean的实例化方式有：</p>
<ul>
<li>构造方法</li>
<li>静态工厂方法</li>
<li>Bean工厂方法</li>
<li><code>FactoryBean</code></li>
<li><code>ServiceLoaderFactoryBean</code></li>
<li><code>AutowireCapableBeanFactory</code></li>
<li><code>BeanDefinitionRegistry.registerBeanDefinition(String beanName, BeanDefinition beanDefinition)</code></li>
</ul>
<p>新建文件<code>bean-instantiation.xml</code>，并创建一个Bean：
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans</span>
<span class="s">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;person-by-constructor&quot;</span> <span class="na">class=</span><span class="s">&quot;deep.in.spring.ioc.overview.domain.Person&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">value=</span><span class="s">&quot;Tommy&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;age&quot;</span> <span class="na">value=</span><span class="s">&quot;20&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></p>
<p>通过**构造方法**实例化Bean的时候，要求Bean类有对应的构造方法：
<div class="highlight"><pre><span></span><code>    <span class="kd">public</span> <span class="nf">Person</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="nf">Person</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">age</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">age</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></p>
<p>提供有参构造方法时，要显式给出无参默认构造方法。</p>
<p>编写引导程序：
<div class="highlight"><pre><span></span><code> <span class="kn">package</span> <span class="nn">deep.in.spring.bean.definition</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.ioc.overview.domain.Person</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.BeanFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.ClassPathXmlApplicationContext</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Bean 实例化示例</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeanInstantiationDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//配置XML配置文件</span>
        <span class="c1">//启动Spring应用上下文</span>
        <span class="n">BeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathXmlApplicationContext</span><span class="p">(</span><span class="s">&quot;classpath:/bean-instantiation.xml&quot;</span><span class="p">);</span>
        <span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;person-by-constructor&quot;</span><span class="p">,</span> <span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">person</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>运行即可得到结果：
<div class="highlight"><pre><span></span><code>Person{name=&#39;Tommy&#39;, age=20}
</code></pre></div></p>
<p>通过**静态工厂方法**实例化Bean时，可以使用<code>bean</code>元素的<code>factory-method</code>属性：
<div class="highlight"><pre><span></span><code>    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;person-by-static-method&quot;</span> <span class="na">class=</span><span class="s">&quot;deep.in.spring.ioc.overview.domain.Person&quot;</span> <span class="na">factory-method=</span><span class="s">&quot;createPerson&quot;</span><span class="nt">/&gt;</span>
</code></pre></div></p>
<p>同样，在<code>Person</code>类中，也要定义对应方法：
<div class="highlight"><pre><span></span><code>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Person</span> <span class="nf">createPerson</span><span class="p">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Person</span><span class="p">(</span><span class="s">&quot;Tom&quot;</span><span class="p">,</span><span class="mi">21</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></p>
<p>修改引导程序的对应代码即可：
<div class="highlight"><pre><span></span><code>    <span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;person-by-static-method&quot;</span><span class="p">,</span> <span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</code></pre></div></p>
<p>通过**Bean工厂方法**来实例化Bean时，需要创建对应的Bean工厂类：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.bean.factory</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.ioc.overview.domain.Person</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * {@link Person} 工厂类</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PersonFactory</span> <span class="p">{</span>
    <span class="k">default</span> <span class="n">Person</span> <span class="nf">createPerson</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">Person</span><span class="p">.</span><span class="na">createPerson</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>使用**Java 8**以上版本时，可以在接口中给出默认实现，而实现类中可以不用写：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.bean.factory</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 默认 {@link PersonFactory} 实现</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultPersonFactory</span> <span class="kd">implements</span> <span class="n">PersonFactory</span> <span class="p">{</span>
<span class="p">}</span>
</code></pre></div></p>
<p>这里依然需要接口的实现类，因为接口不能被实例化。</p>
<p>对工厂类进行配置：
<div class="highlight"><pre><span></span><code>        <span class="c">&lt;!-- 静态方法实例化 Bean --&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;person-by-static-method&quot;</span> <span class="na">class=</span><span class="s">&quot;deep.in.spring.ioc.overview.domain.Person&quot;</span> <span class="na">factory-method=</span><span class="s">&quot;createPerson&quot;</span><span class="nt">/&gt;</span>

        <span class="c">&lt;!-- 实例(Bean)方法实例化 Bean --&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;person-by-instance-method&quot;</span> <span class="na">factory-bean=</span><span class="s">&quot;personFactory&quot;</span> <span class="na">factory-method=</span><span class="s">&quot;createPerson&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;personFactory&quot;</span> <span class="na">class=</span><span class="s">&quot;deep.in.spring.bean.factory.DefaultPersonFactory&quot;</span><span class="nt">/&gt;</span>
</code></pre></div></p>
<p>作为对比，可以看出和静态方法实现的区别。</p>
<p>同时修改引导程序：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.bean.definition</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.ioc.overview.domain.Person</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.BeanFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.ClassPathXmlApplicationContext</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Bean 实例化示例</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeanInstantiationDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//配置XML配置文件</span>
        <span class="c1">//启动Spring应用上下文</span>
        <span class="n">BeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathXmlApplicationContext</span><span class="p">(</span><span class="s">&quot;classpath:/bean-instantiation.xml&quot;</span><span class="p">);</span>
        <span class="n">Person</span> <span class="n">personByStaticMethod</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;person-by-static-method&quot;</span><span class="p">,</span> <span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">Person</span> <span class="n">personByInstanceMethod</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;person-by-instance-method&quot;</span><span class="p">,</span> <span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">personByStaticMethod</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">personByInstanceMethod</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">personByStaticMethod</span> <span class="o">==</span> <span class="n">personByInstanceMethod</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>因为通过两种不同方式创建的Bean，那么Bean的地址比较自然是不想等的，结果为：
<div class="highlight"><pre><span></span><code>Person{name=&#39;Tom&#39;, age=21}
Person{name=&#39;Tom&#39;, age=21}
false
</code></pre></div></p>
<p>通过 <strong><code>FactoryBean</code></strong> 来实例化Bean时，需要创建<code>FactoryBean</code>：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.bean.factory</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.ioc.overview.domain.Person</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.FactoryBean</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * {@link Person} 的 {@link FactoryBean} 实现</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PersonFactoryBean</span> <span class="kd">implements</span> <span class="n">FactoryBean</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getObject</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">Person</span><span class="p">.</span><span class="na">createPerson</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getObjectType</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>之后进行配置：
<div class="highlight"><pre><span></span><code>        <span class="c">&lt;!-- FactoryBean实例化 Bean --&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;person-by-factory-bean&quot;</span> <span class="na">class=</span><span class="s">&quot;deep.in.spring.bean.factory.PersonFactoryBean&quot;</span><span class="nt">/&gt;</span>
</code></pre></div></p>
<p>修改引导程序：
<div class="highlight"><pre><span></span><code>        <span class="n">BeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathXmlApplicationContext</span><span class="p">(</span><span class="s">&quot;classpath:/bean-instantiation.xml&quot;</span><span class="p">);</span>
        <span class="n">Person</span> <span class="n">personByStaticMethod</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;person-by-static-method&quot;</span><span class="p">,</span> <span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">Person</span> <span class="n">personByInstanceMethod</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;person-by-instance-method&quot;</span><span class="p">,</span> <span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">Person</span> <span class="n">personByFactoryBean</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;person-by-factory-bean&quot;</span><span class="p">,</span><span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">personByStaticMethod</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">personByInstanceMethod</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">personByFactoryBean</span><span class="p">);</span>

        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">personByStaticMethod</span> <span class="o">==</span> <span class="n">personByInstanceMethod</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">personByStaticMethod</span> <span class="o">==</span> <span class="n">personByFactoryBean</span><span class="p">);</span>
</code></pre></div></p>
<p>运行程序，得到结果：
<div class="highlight"><pre><span></span><code>Person{name=&#39;Tom&#39;, age=21}
Person{name=&#39;Tom&#39;, age=21}
Person{name=&#39;Tom&#39;, age=21}
false
false
</code></pre></div></p>
<p>通过 <strong><code>ServiceLoaderFactoryBean</code></strong> 来实例化Bean时，使用的时Java SPI机制的实现<code>ServiceLoader</code>。其要求在<code>classpath</code>下的<code>META-INF/services</code>中放置配置文件和实现。文件名就是接口的完全限定名，内容是接口对应的实现类。</p>
<p>例如前面定义的<code>deep.in.spring.bean.factory.PersonFactory</code>：
<div class="highlight"><pre><span></span><code>$ pwd
/Users/nanlei/Dev/Codebase/deep-in-spring-boot/spring-bean/src
$ tree .
.
├── main
│   ├── java
│   │   └── deep
│   │       └── in
│   │           └── spring
│   │               └── bean
│   │                   ├── definition
│   │                   │   ├── AnnotationBeanDefinitionDemo.java
│   │                   │   ├── BeanAliasDemo.java
│   │                   │   ├── BeanDefinitionDemo.java
│   │                   │   ├── BeanInstantiationDemo.java
│   │                   │   └── SpecialBeanInstantiationDemo.java
│   │                   ├── demo
│   │                   │   └── ServiceLoaderDemo.java
│   │                   └── factory
│   │                       ├── DefaultPersonFactory.java
│   │                       ├── PersonFactory.java
│   │                       └── PersonFactoryBean.java
│   └── resources
│       ├── META-INF
│       │   └── services
│       │       └── deep.in.spring.bean.factory.PersonFactory
│       ├── bean-definitions.xml
│       ├── bean-instantiation.xml
│       └── special-bean-instantiation.xml
└── test
    └── java

14 directories, 13 files
</code></pre></div></p>
<p>其内容为：
<div class="highlight"><pre><span></span><code>deep.in.spring.bean.factory.DefaultPersonFactory
</code></pre></div></p>
<p>不同的实现可以分行列举，但相同实现仅有一个有效。</p>
<p><code>ServiceLoader</code>的使用也很简单：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.bean.demo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.bean.factory.PersonFactory</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.ServiceLoader</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServiceLoaderDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ServiceLoader</span><span class="o">&lt;</span><span class="n">PersonFactory</span><span class="o">&gt;</span> <span class="n">serviceLoader</span> <span class="o">=</span> <span class="n">ServiceLoader</span><span class="p">.</span><span class="na">load</span><span class="p">(</span><span class="n">PersonFactory</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">getContextClassLoader</span><span class="p">());</span>
        <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">PersonFactory</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">serviceLoader</span><span class="p">.</span><span class="na">iterator</span><span class="p">();</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">iterator</span><span class="p">.</span><span class="na">hasNext</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">PersonFactory</span> <span class="n">personFactory</span> <span class="o">=</span> <span class="n">iterator</span><span class="p">.</span><span class="na">next</span><span class="p">();</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">personFactory</span><span class="p">.</span><span class="na">createPerson</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>运行，即可得到结果：
<div class="highlight"><pre><span></span><code>Person{name=&#39;Tom&#39;, age=21}
</code></pre></div></p>
<p>结合Spring Framework，就是使用<code>org.springframework.beans.factory.serviceloader.ServiceLoaderFactoryBean</code>：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">org.springframework.beans.factory.serviceloader</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.ServiceLoader</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.BeanClassLoaderAware</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * {@link org.springframework.beans.factory.FactoryBean} that exposes the</span>
<span class="cm"> * JDK 1.6 {@link java.util.ServiceLoader} for the configured service class.</span>
<span class="cm"> *</span>
<span class="cm"> * @author Juergen Hoeller</span>
<span class="cm"> * @since 2.5</span>
<span class="cm"> * @see java.util.ServiceLoader</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServiceLoaderFactoryBean</span> <span class="kd">extends</span> <span class="n">AbstractServiceLoaderBasedFactoryBean</span> <span class="kd">implements</span> <span class="n">BeanClassLoaderAware</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">Object</span> <span class="nf">getObjectToExpose</span><span class="p">(</span><span class="n">ServiceLoader</span><span class="o">&lt;?&gt;</span> <span class="n">serviceLoader</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">serviceLoader</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getObjectType</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">ServiceLoader</span><span class="p">.</span><span class="na">class</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></p>
<p>其返回的就是<code>ServiceLoader</code>本身，使用该FactoryBean需要注入<code>serviceType</code>，其定义在父类<code>AbstractServiceLoaderBasedFactoryBean</code>中。而<code>AbstractServiceLoaderBasedFactoryBean</code>的另外两个实现：
<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServiceFactoryBean</span> <span class="kd">extends</span> <span class="n">AbstractServiceLoaderBasedFactoryBean</span> <span class="kd">implements</span> <span class="n">BeanClassLoaderAware</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">Object</span> <span class="nf">getObjectToExpose</span><span class="p">(</span><span class="n">ServiceLoader</span><span class="o">&lt;?&gt;</span> <span class="n">serviceLoader</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Iterator</span><span class="o">&lt;?&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="n">serviceLoader</span><span class="p">.</span><span class="na">iterator</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">it</span><span class="p">.</span><span class="na">hasNext</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="p">(</span>
                    <span class="s">&quot;ServiceLoader could not find service for type [&quot;</span> <span class="o">+</span> <span class="n">getServiceType</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">it</span><span class="p">.</span><span class="na">next</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@Nullable</span>
    <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getObjectType</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">getServiceType</span><span class="p">();</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServiceListFactoryBean</span> <span class="kd">extends</span> <span class="n">AbstractServiceLoaderBasedFactoryBean</span> <span class="kd">implements</span> <span class="n">BeanClassLoaderAware</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">Object</span> <span class="nf">getObjectToExpose</span><span class="p">(</span><span class="n">ServiceLoader</span><span class="o">&lt;?&gt;</span> <span class="n">serviceLoader</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Object</span> <span class="n">loaderObject</span> <span class="p">:</span> <span class="n">serviceLoader</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">result</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">loaderObject</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getObjectType</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">List</span><span class="p">.</span><span class="na">class</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>

<p>根据<code>getObjectToExpose(ServiceLoader&lt;?&gt; serviceLoader)</code>方法的返回内容确定使用场景。</p>
<p>这里新建<code>special-bean-instantiation.xml</code>文件：
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans</span>
<span class="s">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;personFactoryServiceLoader&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.beans.factory.serviceloader.ServiceLoaderFactoryBean&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;serviceType&quot;</span> <span class="na">value=</span><span class="s">&quot;deep.in.spring.bean.factory.PersonFactory&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></p>
<p>定义<code>personFactoryServiceLoader</code> Bean并注入依赖<code>serviceType</code>。</p>
<p>编写引导程序：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.bean.definition</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.bean.factory.PersonFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.BeanFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.ClassPathXmlApplicationContext</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.ServiceLoader</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpecialBeanInstantiationDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//配置XML配置文件</span>
        <span class="c1">//启动Spring应用上下文</span>
        <span class="n">BeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathXmlApplicationContext</span><span class="p">(</span><span class="s">&quot;classpath:/special-bean-instantiation.xml&quot;</span><span class="p">);</span>
        <span class="n">ServiceLoader</span><span class="o">&lt;</span><span class="n">PersonFactory</span><span class="o">&gt;</span> <span class="n">serviceLoader</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;personFactoryServiceLoader&quot;</span><span class="p">,</span> <span class="n">ServiceLoader</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">displayServiceLoader</span><span class="p">(</span><span class="n">serviceLoader</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">displayServiceLoader</span><span class="p">(</span><span class="n">ServiceLoader</span><span class="o">&lt;</span><span class="n">PersonFactory</span><span class="o">&gt;</span> <span class="n">serviceLoader</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">PersonFactory</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">serviceLoader</span><span class="p">.</span><span class="na">iterator</span><span class="p">();</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">iterator</span><span class="p">.</span><span class="na">hasNext</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">PersonFactory</span> <span class="n">personFactory</span> <span class="o">=</span> <span class="n">iterator</span><span class="p">.</span><span class="na">next</span><span class="p">();</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">personFactory</span><span class="p">.</span><span class="na">createPerson</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>通过 <strong><code>AutowireCapableBeanFactory</code></strong> 来实例化Bean时，直接使用Java API来实现：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.bean.definition</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.bean.factory.DefaultPersonFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">deep.in.spring.bean.factory.PersonFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.config.AutowireCapableBeanFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.GenericApplicationContext</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.ServiceLoader</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpecialBeanInstantiationDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//启动 Spring 应用上下文</span>
        <span class="n">GenericApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GenericApplicationContext</span><span class="p">();</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">refresh</span><span class="p">();</span>
        <span class="c1">//通过 ApplicationContext 获取 AutowireCapableBeanFactory</span>
        <span class="n">AutowireCapableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="p">.</span><span class="na">getAutowireCapableBeanFactory</span><span class="p">();</span>
        <span class="c1">//通过 AutowireCapableBeanFactory 创建 PersonFactory</span>
        <span class="n">PersonFactory</span> <span class="n">personFactory</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="p">.</span><span class="na">createBean</span><span class="p">(</span><span class="n">DefaultPersonFactory</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">personFactory</span><span class="p">.</span><span class="na">createPerson</span><span class="p">());</span>
        <span class="c1">//关闭 Spring 应用上下文</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">displayServiceLoader</span><span class="p">(</span><span class="n">ServiceLoader</span><span class="o">&lt;</span><span class="n">PersonFactory</span><span class="o">&gt;</span> <span class="n">serviceLoader</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">PersonFactory</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">serviceLoader</span><span class="p">.</span><span class="na">iterator</span><span class="p">();</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">iterator</span><span class="p">.</span><span class="na">hasNext</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">PersonFactory</span> <span class="n">personFactory</span> <span class="o">=</span> <span class="n">iterator</span><span class="p">.</span><span class="na">next</span><span class="p">();</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">personFactory</span><span class="p">.</span><span class="na">createPerson</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>需要注意的是<code>AutowireCapableBeanFactory.createBean(Class&lt;T&gt; beanClass)</code>方法的参数必须是实现类，而不能是接口或抽象类。</p>
<h2 id="5-spring-bean">5. 初始化Spring Bean<a class="headerlink" href="#5-spring-bean" title="Permanent link">&para;</a></h2>
<p>Bean的初始化方式有：</p>
<ul>
<li><code>@PostConstruct</code></li>
<li>实现<code>InitializingBean</code>的<code>afterPropertiesSet()</code>方法</li>
<li>自定义初始化方法：<ul>
<li><code>&lt;bean init-method="" .../&gt;</code></li>
<li><code>@Bean(initMethod="init")</code></li>
<li><code>AbstractBeanDefinition.setInitMethodName(@Nullable String initMethodName)</code> </li>
</ul>
</li>
</ul>
<p><code>@PostConstruct</code>注解是Java的标准注解：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">javax.annotation</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.*</span><span class="p">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.*</span><span class="p">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.RetentionPolicy.*</span><span class="p">;</span>

<span class="nd">@Documented</span>
<span class="nd">@Retention</span> <span class="p">(</span><span class="n">RUNTIME</span><span class="p">)</span>
<span class="nd">@Target</span><span class="p">(</span><span class="n">METHOD</span><span class="p">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">PostConstruct</span> <span class="p">{</span>
<span class="p">}</span>
</code></pre></div></p>
<p>在方法上标注即可：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.bean.factory</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.PostConstruct</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 默认 {@link PersonFactory} 实现</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultPersonFactory</span> <span class="kd">implements</span> <span class="n">PersonFactory</span> <span class="p">{</span>
    <span class="c1">//@PostConstruct 注解实现</span>
    <span class="nd">@PostConstruct</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;@PostConstruct: &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; is initializing...&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>创建引导程序：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.bean.definition</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.bean.factory.DefaultPersonFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">deep.in.spring.bean.factory.PersonFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.AnnotationConfigApplicationContext</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Bean 初始化示例</span>
<span class="cm"> */</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeanInitializationDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//创建 BeanFactory 容器</span>
        <span class="n">AnnotationConfigApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnotationConfigApplicationContext</span><span class="p">();</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">BeanInitializationDemo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="c1">//启动 Spring 应用上下文</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">refresh</span><span class="p">();</span>
        <span class="c1">//依赖查找 PersonFactory</span>
        <span class="n">PersonFactory</span> <span class="n">personFactory</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">PersonFactory</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="c1">//关闭 Spring 应用上下文</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">PersonFactory</span> <span class="nf">personFactory</span><span class="p">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">DefaultPersonFactory</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>运行程序，即可得到：
<div class="highlight"><pre><span></span><code>@PostConstruct: deep.in.spring.bean.factory.DefaultPersonFactory is initializing...
</code></pre></div></p>
<p>修改<code>@Bean</code>注解：
<div class="highlight"><pre><span></span><code>    <span class="nd">@Bean</span><span class="p">(</span><span class="n">initMethod</span> <span class="o">=</span> <span class="s">&quot;initPersonFactory&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">PersonFactory</span> <span class="nf">personFactory</span><span class="p">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">DefaultPersonFactory</span><span class="p">();</span>
    <span class="p">}</span>
</code></pre></div></p>
<p>就可以自行指定初始化方法了，在<code>DefaultPersonFactory</code>中添加对应的方法即可：
<div class="highlight"><pre><span></span><code>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initPersonFactory</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Custom initMethod in @Bean: &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; is initializing...&quot;</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></p>
<p>实现<code>InitializingBean</code>的<code>afterPropertiesSet()</code>方法时，需要对<code>DefaultPersonFactory</code>再次修改：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.bean.factory</span><span class="p">;</span>


<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.InitializingBean</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.PostConstruct</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 默认 {@link PersonFactory} 实现</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultPersonFactory</span> <span class="kd">implements</span> <span class="n">PersonFactory</span><span class="p">,</span> <span class="n">InitializingBean</span> <span class="p">{</span>
    <span class="c1">//@PostConstruct 注解实现</span>
    <span class="nd">@PostConstruct</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;@PostConstruct: &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; is initializing...&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initPersonFactory</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Custom initMethod in @Bean: &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; is initializing...&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;InitializingBean.afterPropertiesSet(): &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; is initializing...&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>再次运行引导程序，可以得到：
<div class="highlight"><pre><span></span><code>@PostConstruct: deep.in.spring.bean.factory.DefaultPersonFactory is initializing...
InitializingBean.afterPropertiesSet(): deep.in.spring.bean.factory.DefaultPersonFactory is initializing...
Custom initMethod in @Bean: deep.in.spring.bean.factory.DefaultPersonFactory is initializing...
</code></pre></div></p>
<p>三种方式的顺序时固定的，首先是<code>@PostConstruct</code>，其次是<code>InitializingBean.afterPropertiesSet()</code>，最后是自定义实现。</p>
<h2 id="6-spring-bean">6. 延迟初始化Spring Bean<a class="headerlink" href="#6-spring-bean" title="Permanent link">&para;</a></h2>
<p>Bean的延迟初始化方式有：</p>
<ul>
<li><code>&lt;bean lazy-init="true" .../&gt;</code></li>
<li><code>@Lazy(true)</code></li>
</ul>
<p>两种方式使用上没有区别，主要是要了解Bean延迟加载的时机。</p>
<p>修改上面的引导程序：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.bean.definition</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.bean.factory.DefaultPersonFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">deep.in.spring.bean.factory.PersonFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.AnnotationConfigApplicationContext</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Bean 初始化示例</span>
<span class="cm"> */</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeanInitializationDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//创建 BeanFactory 容器</span>
        <span class="n">AnnotationConfigApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnotationConfigApplicationContext</span><span class="p">();</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">BeanInitializationDemo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="c1">//启动 Spring 应用上下文</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">refresh</span><span class="p">();</span>
        <span class="c1">//非延迟初始化在 Spring 上下文启动完成后，被初始化</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Spring applicationContext started...&quot;</span><span class="p">);</span>
        <span class="c1">//依赖查找 PersonFactory</span>
        <span class="n">PersonFactory</span> <span class="n">personFactory</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">PersonFactory</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">personFactory</span><span class="p">);</span>
        <span class="c1">//关闭 Spring 应用上下文</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nd">@Bean</span><span class="p">(</span><span class="n">initMethod</span> <span class="o">=</span> <span class="s">&quot;initPersonFactory&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">PersonFactory</span> <span class="nf">personFactory</span><span class="p">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">DefaultPersonFactory</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>没有设置延迟加载的时候，再次进行输出，得到：
<div class="highlight"><pre><span></span><code>@PostConstruct: deep.in.spring.bean.factory.DefaultPersonFactory is initializing...
InitializingBean.afterPropertiesSet(): deep.in.spring.bean.factory.DefaultPersonFactory is initializing...
Custom initMethod in @Bean: deep.in.spring.bean.factory.DefaultPersonFactory is initializing...
Spring applicationContext started...
deep.in.spring.bean.factory.DefaultPersonFactory@ba8d91c
</code></pre></div></p>
<p>使用注解方式开启延迟加载：
<div class="highlight"><pre><span></span><code>    <span class="nd">@Bean</span><span class="p">(</span><span class="n">initMethod</span> <span class="o">=</span> <span class="s">&quot;initPersonFactory&quot;</span><span class="p">)</span>
    <span class="nd">@Lazy</span>
    <span class="kd">public</span> <span class="n">PersonFactory</span> <span class="nf">personFactory</span><span class="p">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">DefaultPersonFactory</span><span class="p">();</span>
    <span class="p">}</span>
</code></pre></div></p>
<p>再次运行，得到：
<div class="highlight"><pre><span></span><code>Spring applicationContext started...
@PostConstruct: deep.in.spring.bean.factory.DefaultPersonFactory is initializing...
InitializingBean.afterPropertiesSet(): deep.in.spring.bean.factory.DefaultPersonFactory is initializing...
Custom initMethod in @Bean: deep.in.spring.bean.factory.DefaultPersonFactory is initializing...
deep.in.spring.bean.factory.DefaultPersonFactory@7ff2a664
</code></pre></div></p>
<p>可以看出，在开启延迟加载时，进行依赖查找的时候触发了延迟加载操作。二者只是时机不同。</p>
<h2 id="7-spring-bean">7. 销毁Spring Bean<a class="headerlink" href="#7-spring-bean" title="Permanent link">&para;</a></h2>
<p>Bean的销毁方式有：</p>
<ul>
<li><code>@PreDestroy</code></li>
<li>实现<code>DisposableBean</code>的<code>destroy()</code>方法</li>
<li>自定义销毁方法：<ul>
<li><code>&lt;bean destroy-method="destroy" .../&gt;</code></li>
<li><code>@Bean(destroyMethod="destroy")</code> </li>
<li><code>AbstractBeanDefinition.setDestroyMethodName(@Nullable String destroyMethodName)</code> </li>
</ul>
</li>
</ul>
<p>和初始化Spring Bean类似，销毁也有3大类方法。</p>
<p>将3中销毁方法在<code>DefaultPersonFactory</code>中对应声明：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.bean.factory</span><span class="p">;</span>


<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.DisposableBean</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.InitializingBean</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.PostConstruct</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.annotation.PreDestroy</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 默认 {@link PersonFactory} 实现</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultPersonFactory</span> <span class="kd">implements</span> <span class="n">PersonFactory</span><span class="p">,</span> <span class="n">InitializingBean</span><span class="p">,</span> <span class="n">DisposableBean</span> <span class="p">{</span>
    <span class="c1">//@PostConstruct 注解实现</span>
    <span class="nd">@PostConstruct</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;@PostConstruct: &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; is initializing...&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initPersonFactory</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Custom initMethod in @Bean: &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; is initializing...&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;InitializingBean.afterPropertiesSet(): &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; is initializing...&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@PreDestroy</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">preDestroy</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;@PreDestroy: &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; is destroying...&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroyPersonFactory</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Custom destroy method in @Bean: &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; is destroying...&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;DisposableBean.destroy(): &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; is destroying...&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>修改引导程序：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.bean.definition</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">deep.in.spring.bean.factory.DefaultPersonFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">deep.in.spring.bean.factory.PersonFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.AnnotationConfigApplicationContext</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Lazy</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Bean 初始化示例</span>
<span class="cm"> */</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeanInitializationDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//创建 BeanFactory 容器</span>
        <span class="n">AnnotationConfigApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnotationConfigApplicationContext</span><span class="p">();</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">BeanInitializationDemo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="c1">//启动 Spring 应用上下文</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">refresh</span><span class="p">();</span>
        <span class="c1">//非延迟初始化在 Spring 上下文启动完成后，被初始化</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Spring applicationContext started...&quot;</span><span class="p">);</span>
        <span class="c1">//依赖查找 PersonFactory</span>
        <span class="n">PersonFactory</span> <span class="n">personFactory</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">PersonFactory</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">personFactory</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Spring applicationContext ready to close...&quot;</span><span class="p">);</span>
        <span class="c1">//关闭 Spring 应用上下文</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Spring applicationContext closed...&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Bean</span><span class="p">(</span><span class="n">initMethod</span> <span class="o">=</span> <span class="s">&quot;initPersonFactory&quot;</span><span class="p">,</span> <span class="n">destroyMethod</span> <span class="o">=</span> <span class="s">&quot;destroyPersonFactory&quot;</span><span class="p">)</span>
    <span class="nd">@Lazy</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">PersonFactory</span> <span class="nf">personFactory</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">DefaultPersonFactory</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>关闭延迟加载特性，再次运行，得到结果：
<div class="highlight"><pre><span></span><code>@PostConstruct: deep.in.spring.bean.factory.DefaultPersonFactory is initializing...
InitializingBean.afterPropertiesSet(): deep.in.spring.bean.factory.DefaultPersonFactory is initializing...
Custom initMethod in @Bean: deep.in.spring.bean.factory.DefaultPersonFactory is initializing...
Spring applicationContext started...
deep.in.spring.bean.factory.DefaultPersonFactory@7ff2a664
Spring applicationContext ready to close...
@PreDestroy: deep.in.spring.bean.factory.DefaultPersonFactory is destroying...
DisposableBean.destroy(): deep.in.spring.bean.factory.DefaultPersonFactory is destroying...
Custom destroy method in @Bean: deep.in.spring.bean.factory.DefaultPersonFactory is destroying...
Spring applicationContext closed...
</code></pre></div></p>
<p>可以看到销毁方法是在调用了<code>applicationContext.close()</code>之后进行触发的，且顺序也是按照<code>@PreDestroy</code>优先，<code>DisposableBean.destroy()</code>其次，最后是自定义销毁方法。</p>
<p>由<code>applicationContext.close()</code>方法跟踪，其调用的是<code>AbstractApplicationContext.close()</code>，在<code>doClose()</code>方法中：
<div class="highlight"><pre><span></span><code><span class="c1">// Destroy all cached singletons in the context&#39;s BeanFactory.</span>
<span class="n">destroyBeans</span><span class="p">();</span>
</code></pre></div></p>
<p>继续跟踪<code>destroyBeans()</code>方法：
<div class="highlight"><pre><span></span><code>    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">destroyBeans</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">getBeanFactory</span><span class="p">().</span><span class="na">destroySingletons</span><span class="p">();</span>
    <span class="p">}</span>
</code></pre></div></p>
<p><code>destroySingletons()</code>方法是<code>ConfigurableBeanFactory</code>接口定义的，在<code>DefaultListableBeanFactory</code>实现中(<a href="../01-spring-ioc/#5.4">可以参考</a>)，继续查看该方法：
<div class="highlight"><pre><span></span><code>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroySingletons</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">super</span><span class="p">.</span><span class="na">destroySingletons</span><span class="p">();</span>
        <span class="n">updateManualSingletonNames</span><span class="p">(</span><span class="n">Set</span><span class="p">::</span><span class="n">clear</span><span class="p">,</span> <span class="n">set</span> <span class="o">-&gt;</span> <span class="o">!</span><span class="n">set</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">());</span>
        <span class="n">clearByTypeCache</span><span class="p">();</span>
    <span class="p">}</span>
</code></pre></div></p>
<p>在<code>DefaultSingletonBeanRegistry</code>中：
<div class="highlight"><pre><span></span><code>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroySingletons</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isTraceEnabled</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">logger</span><span class="p">.</span><span class="na">trace</span><span class="p">(</span><span class="s">&quot;Destroying singletons in &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="kd">synchronized</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">singletonObjects</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="na">singletonsCurrentlyInDestruction</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">String</span><span class="o">[]</span> <span class="n">disposableBeanNames</span><span class="p">;</span>
        <span class="kd">synchronized</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">disposableBeans</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">disposableBeanNames</span> <span class="o">=</span> <span class="n">StringUtils</span><span class="p">.</span><span class="na">toStringArray</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">disposableBeans</span><span class="p">.</span><span class="na">keySet</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">disposableBeanNames</span><span class="p">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">destroySingleton</span><span class="p">(</span><span class="n">disposableBeanNames</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="na">containedBeanMap</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="na">dependentBeanMap</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="na">dependenciesForBeanMap</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span>

        <span class="n">clearSingletonCache</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroySingleton</span><span class="p">(</span><span class="n">String</span> <span class="n">beanName</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Remove a registered singleton of the given name, if any.</span>
        <span class="n">removeSingleton</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>

        <span class="c1">// Destroy the corresponding DisposableBean instance.</span>
        <span class="n">DisposableBean</span> <span class="n">disposableBean</span><span class="p">;</span>
        <span class="kd">synchronized</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">disposableBeans</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">disposableBean</span> <span class="o">=</span> <span class="p">(</span><span class="n">DisposableBean</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="na">disposableBeans</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">destroyBean</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">disposableBean</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></p>
<p>在<code>destroyBean(String beanName, @Nullable DisposableBean bean)</code>中断点调试：
<img alt="" src="../img/spring.beans.destroy.png" /></p>
<p>可以看到，会继续调用<code>DisposableBeanAdapter</code>的<code>destroy()</code>方法，这里面定义了<code>@PreDestroy</code>注解、<code>DisposableBean.destroy()</code>方法和自定义销毁方法的执行顺序：
<div class="highlight"><pre><span></span><code>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CollectionUtils</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">beanPostProcessors</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">DestructionAwareBeanPostProcessor</span> <span class="n">processor</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="na">beanPostProcessors</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">processor</span><span class="p">.</span><span class="na">postProcessBeforeDestruction</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">bean</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="na">beanName</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">invokeDisposableBean</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isTraceEnabled</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">logger</span><span class="p">.</span><span class="na">trace</span><span class="p">(</span><span class="s">&quot;Invoking destroy() on bean with name &#39;&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="na">beanName</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getSecurityManager</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">AccessController</span><span class="p">.</span><span class="na">doPrivileged</span><span class="p">((</span><span class="n">PrivilegedExceptionAction</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="p">{</span>
                        <span class="p">((</span><span class="n">DisposableBean</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="na">bean</span><span class="p">).</span><span class="na">destroy</span><span class="p">();</span>
                        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                    <span class="p">},</span> <span class="k">this</span><span class="p">.</span><span class="na">acc</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="p">((</span><span class="n">DisposableBean</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="na">bean</span><span class="p">).</span><span class="na">destroy</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Invocation of destroy method failed on bean with name &#39;&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="na">beanName</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isDebugEnabled</span><span class="p">())</span> <span class="p">{</span>
                    <span class="n">logger</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="n">logger</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="n">ex</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">destroyMethod</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">invokeCustomDestroyMethod</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">destroyMethod</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">destroyMethodName</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Method</span> <span class="n">methodToInvoke</span> <span class="o">=</span> <span class="n">determineDestroyMethod</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">destroyMethodName</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">methodToInvoke</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">invokeCustomDestroyMethod</span><span class="p">(</span><span class="n">ClassUtils</span><span class="p">.</span><span class="na">getInterfaceMethodIfPossible</span><span class="p">(</span><span class="n">methodToInvoke</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></p>
<p>Bean被销毁后，还可以继续进行垃圾回收(GC)，在Bean的实现类中覆盖<code>Object</code>类的<code>protected void finalize() throws Throwable</code>方法：
<div class="highlight"><pre><span></span><code>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">finalize</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; is finalizing...&quot;</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></p>
<p>编写测试类：
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">deep.in.spring.bean.definition</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.AnnotationConfigApplicationContext</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeanGCDemo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="p">{</span>
        <span class="c1">//创建 BeanFactory 容器</span>
        <span class="n">AnnotationConfigApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnotationConfigApplicationContext</span><span class="p">();</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">BeanInitializationDemo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="c1">//启动 Spring 应用上下文</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">refresh</span><span class="p">();</span>
        <span class="c1">//关闭 Spring 应用上下文</span>
        <span class="n">applicationContext</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Spring applicationContext closed...&quot;</span><span class="p">);</span>
        <span class="c1">//强制触发 GC</span>
        <span class="n">System</span><span class="p">.</span><span class="na">gc</span><span class="p">();</span>
        <span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">10000L</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>因为强制触发GC也不能保证对象的<code>finalize</code>方法立刻被调用，可以使用<code>Thread.sleep</code>来观察效果，可以得到结果：
<div class="highlight"><pre><span></span><code>@PostConstruct: deep.in.spring.bean.factory.DefaultPersonFactory is initializing...
InitializingBean.afterPropertiesSet(): deep.in.spring.bean.factory.DefaultPersonFactory is initializing...
Custom initMethod in @Bean: deep.in.spring.bean.factory.DefaultPersonFactory is initializing...
@PreDestroy: deep.in.spring.bean.factory.DefaultPersonFactory is destroying...
DisposableBean.destroy(): deep.in.spring.bean.factory.DefaultPersonFactory is destroying...
Custom destroy method in @Bean: deep.in.spring.bean.factory.DefaultPersonFactory is destroying...
Spring applicationContext closed...
deep.in.spring.bean.factory.DefaultPersonFactory is finalizing...
</code></pre></div></p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../01-spring-ioc/" title="Spring IoC" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Spring IoC
              </div>
            </div>
          </a>
        
        
          <a href="../spring-annotation-stereotype-annotation/" title="Stereotype Annotation" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Stereotype Annotation
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2020 Nan Lei
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.d1f5a259.min.js"></script>
      <script src="../../assets/javascripts/bundle.d5fec882.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: ["tabs"],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.fae956e7.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="../../javascripts/extra.js"></script>
      
    
  </body>
</html>